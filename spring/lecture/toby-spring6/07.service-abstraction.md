# 섹션 7. 서비스 추상화

## 서비스란 무엇인가?

- 스프링 애플리케이션 빈이 존재하는 계층 구조
    - `@Controller` → Presentation Layer
    - `@Service` → Business Layer
    - `@Repository` → Persistence Layer
- Business Layer
    - 애플리케이션의 비즈니스 로직/도메인 로직의 코드가 위치하는 계층
    - 그 외 다양한 이름으로 불린다.
    - https://martinfowler.com/eaaCatalog/serviceLayer.html
- 서비스는 일반적인 용어라 쓰이는 곳에 따라 다른 의미를 가진다.

### ‘서비스’의 의미

- 백엔드에서 ‘서비스’라는 단어가 가지는 두 가지 의미가 존재한다.
    - 서비스는 클라이언트에게 서비스를 제공해주는 오브젝트나 모듈
        - = 서버
    - 서비스는 일반적으로 상태를 가지지 않는다.
        - stateless
        - 싱글톤 스프링 빈을 사용하기 적합
- 서비스의 종류
    - 애플리케이션 서비스
        - 비즈니스 계층에 존재하는 @Service 애노테이션이 붙은 오브젝트
    - 도메인 서비스
        - 도메인 모델 패턴을 사용할 때 특정 엔티티로 표현하기 힘든 로직을 구현할 때 사용
    - 인프라 서비스
        - 이번 섹션에서 다루는 서비스 추상화의 대상
        - 도메인/애플리케이션 로직에 참여하지 않는다.
        - 기술을 제공하는 서비스 (메일, 캐시, 트랜잭션, 메시징 등)

## 애플리케이션 서비스

- 애플리케이션 서비스란
    - 가장 중요한 도메인/애플리케이션/비즈니스 로직
    - 인프라 레이어에 존재하는 기술에 가능한 의존하지 않도록 만들어야 함
- `Order` 엔티티를 저장하는 애플리케이션 서비스를 작성한다면 아래와 같을 것이다.

```java
@Service
public class OrderService {
  private final OrderRepository orderRepository;
  
  public OrderService(OrderRepository orderRepository) {
    this.orderRepository = orderRepository;
  }
  
  public Order createOrder(String no, BigDecimal total) {
    Order order = new Order(no, total);
    
    orderRepository.save(order);
    
    return order;
  }
}
```

- 위 서비스에 트랜잭션을 적용해보자
    - 트랜잭션을 적용하는 방법으로 `TransactionTemplate`을 이용하는 방법이 있다.
    - `TransactionTemplate`을 사용하려면 `TransactionManager` 의존성이 필요
    - 일단 Jpa를 사용하니 `JpaTransactionManager`를 사용

```java
@Service
public class OrderService {
  private final OrderRepository orderRepository;
  private final JpaTransactionManager transactionManager; 
  
  public OrderService(OrderRepository orderRepository, JpaTransactionManager transactionManager) {
    this.orderRepository = orderRepository;
    this.transactionManager = transactionManager;
  }
  
  public Order createOrder(String no, BigDecimal total) {
    Order order = new Order(no, total);
    
    return new TransactoinTemplate(transactionManager)
      .execute(status -> {
        orderRepository.save(order);
        return order;
      });
  }
}
```
