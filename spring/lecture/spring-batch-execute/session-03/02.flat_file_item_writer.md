# FlatFileItemWriter

## FlatFileItemWriter

- 대량의 파일 쓰기 작업을 효율적으로 처리할 수 있다.
- `FlatFileItemReader`와는 반대로 도메인 객체를 문자열로 변환해서 쓴다.
- 파일 쓰기 작업은 크게 두 단계로 나뉜다.
    - 필드 추출 - `FieldExtrator`
    - 문자열 결합 - `LineAggregator`

## FieldExtractor

- 객체 `T`를 `Object`의 배열 형태로 반환한다.

```java
public interface FieldExtractor<T> {
    Object[] extract(T item);
}
```

- `FieldExtractor`도 스프링에서 기본 구현체를 제공한다.
    - `BeanWrapperFieldExtractor`
        - Java bean 객체로부터 필드를 추출
        - 객체 프로퍼티 이름을 기반으로 `getter` 메서드로 필드값을 추출
    - `RecordFieldExtractor`
        - Java Record 객체에서 필드를 추출
        - 레코드 컴포넌트의 accessor 메서드를 호출해 값을 가져온다.
    - 도메인 객체 타입에 따라 두 구현체 중 하나가 자동으로 선택된다.

## LineAggregator

- `T` 도메인 객체를 받아 문자열로 결합하여 반환한다.

```java
public interface LineAggregator<T> {
    String aggregate(T item);
}
```

- 파일 읽기 때와 마찬가지로 구분자 기반과 고정 길이 기반의 Aggregator가 기본적으로 존재한다.
    - `DelimitedLineAggregator`
    - `FormatterLineAggregator`
- `LineAggregator.aggregate()` 내부에서 `FieldExtractor`를 사용하는 구조기에 두 컴포넌트 모두 `T` 타입 객체를 파라미터로 받는다.
    - `LineAggregator`를 구현한 `ExtractorLineAggregator` 추상 클래스 내부에서 `FieldExtractor`를 사용한다.
    - `DelimitedLineAggregator`, `FormatterLineAggregator`은 `ExtractorLineAggregator`를 구현한다.

## 구분자 형식의 파일 쓰기

### FlatFileItemWriterBuilder

- reader 때와 마찬가지로 전문 빌더 클래스로 `FlatFileItemWriter`를 구성한다.

```kotlin
@Bean
@StepScope
fun deathNoteWriter(
    @Value("#{jobParameters['outputDir']}") outputDir: String,
): FlatFileItemWriter<DeathNote> =
    FlatFileItemWriterBuilder<DeathNote>()
        .name("deathNoteWriter")
        .resource(FileSystemResource("$outputDir/death_notes.csv"))
        .delimited()
        .delimiter(",")
        .sourceType(DeathNote::class.java)
        .names("victimId", "victimName", "executionDate", "causeOfDeath")
        .headerCallback { writer: Writer -> writer.write("처형ID,피해자명,처형일자,사인") }
        .build()
```

- `name()`
    - `FlatFileItemWriter`의 고유 이름 지정
- `resource()`
    - `WritableResource` ****타입의 리소스를 지정
    - 위 예제에선 잡 파라미터를 통해 파일 위치를 동적으로 결정
- `delimited()`
    - `LineAggregator` 구현체로 `DelimitedLineAggregator`가 지정된다.

> `FlatFileItemReaderBuilder`에선 `delimited`를 호출하면 `DelimitedLineTokenizer`가 지정되는 것과 유사
>

- `delimiter()`
    - 필드들을 이어붙일 때 사용할 구분자를 지정

- `FieldExtractor` 구성 방법
    - 직접 전달 방식
        - `FlatFileItemWriterBuilder`의 `fieldExtractor()` 메서드를 사용
        - 커스텀 `FieldExtractor`를 사용해야할 때 사용
    - 자동 구성 방식
        - `FlatFileItemWriterBuilder`의 `sourceType()` 메서드로 전달한 도메인 객체에 따라 자동 구성되는 방식
        - 자동 구성 방식에선 `BeanWrapperFieldExtractor`**,** `RecordFieldExtractor`만 지원한다.
        - 도메인 객체가 일반 자바빈 객체인 경우엔 `sourceType`을 호출하지 않아도 자동으로 `BeanWrapperFieldExtractor`가 선택된다.
- `names()`
    - 문자열로 변환할 객체 필드 이름을 지정
    - 이 메서드는 자동 구성 방식에서만 사용된다.
- `headerCallback()`
    - 파일에 헤더를 추가할 수 있도록 콜백을 설정
    - `FlatFileHeaderCallback`이 **전달된다.**
    - `FlatFileItemWriter` 초기화 시 호출되어 헤더를 작성한다.
    - 파일의 마지막에 푸터를 추가할 수 있는 `footerCallback()`도 있다.
