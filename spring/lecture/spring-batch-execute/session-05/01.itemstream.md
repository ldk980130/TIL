# ItemStream

- 앞서 다룬 `ItemReader`, `ItemWriter`들 중에선 실제 데이터 처리를 다른 컴포넌트에게 위임하는 것들이 있었다.
    - `MultiResourceItemReader`**,** `MultiResourceItemWriter`**,** `CompositeItemReader`**,** `CompositeItemWriter`
- 각 위임자 내부 코드엔 `delegate` 필드가 존재한다.

```java
// MultiResourceItemReader
private ResourceAwareItemReaderItemStream<? extends T> delegate;

// MultiResourceItemWriter
private ResourceAwareItemWriterItemStream<? super T> delegate;

// CompositeItemReader
private final List<ItemStreamReader<? extends T>> delegates;
```

- 위임 대상들은 모두 단순 `ItemReader`/`ItemWriter`가 아닌 `ItemStream`을 사용하고 있다.
- 실제로 Spring Batch 대부분의 구현체들은 `ItemStream` 인터페이스를 공통적으로 구현하고 있다.
    - 대부분의 `ItemReader`는 `ItemStream`
    - 하지만 `ItemWriter`의 경우 파일 기반 구현체를 제외하고는 대부분 `ItemStream`이 아니다.

```java
public interface ItemStream {
    default void open(ExecutionContext executionContext) throws ItemStreamException {}
	
    default void update(ExecutionContext executionContext) throws ItemStreamException {}
	
    default void close() throws ItemStreamException {}
}
```

## ItemStream의 역할

- `ItemStream`은 다음 두 역할을 담당한다.
    - 자원 초기화 및 해제
    - 메타데이터 관리 및 상태 추적

### 자원 초기화 및 해제

- 자원 관리의 중요성
  - 배치 작업은 파일, db 커넥션, 메모리 버퍼 등 다양한 자원을 다룬다.
  - 이러한 자원들은 반드시 적절한 사전 준비와 사용 후 정리가 필요하다.
  - 자원을 적절히 해제하지 않으면 치명적 문제가 발생한다.
    - 파일 핸들 누수
    - db 커넥션 누수
    - 메모리 누수
- 이러한 자원 초기화와 해제는 `ItemStream`의 `open()`, `close()` 메서드를 통해 처리된다.
  - Spring Batch에선 스텝이 `open`, `close` 메서드를 호출한다.

- `FlatFileItemReader.doOpen()`
  - 부모 클래스인 `AbstractItemCountingItemStreamItemReader`의 `open()` 메서드에서 `doOpen` 호출

```java
@Override
protected void doOpen() throws Exception {
  if (!resource.exists()) { // 읽을 파일 존재 여부 확인
    if (strict) {
      throw new IllegalStateException("Input resource must exist (reader is in 'strict' mode): " + resource);
    }
    logger.warn("Input resource does not exist " + resource.getDescription());
    return;
  }
// ...
  reader = bufferedReaderFactory.create(resource, encoding); // 데이터를 읽어들일 BufferedReader 준비
}
```

```java
@Override
protected void doClose() throws Exception {
    // ...
    reader.close(); // BufferedReader.close()를 호출하여 파일을 닫음
    // ...
}
```

- `JdbcCursorItemReader.doOpen`
  - 부모 클래스인 `AbstractItemCountingItemStreamItemReader`의 `open()` 메서드에서 `doOpen` 호출

```java
@Override
protected void doOpen() throws Exception {
   // ...
   // DB 연결 초기화 -> this.con = dataSource.getConnection();
   initializeConnection(); 
   openCursor(con); // 커서를 열어 데이터를 읽을 준비
   // ... 
}
```

```java
protected void doClose() throws Exception {
    // ...
    JdbcUtils.closeResultSet(this.rs); // ResultSet 닫기
    rs = null;
    cleanupOnClose(con); // 커서 close
    // ...
    JdbcUtils.closeConnection(this.con); // DB 커넥션 닫기
}
```
