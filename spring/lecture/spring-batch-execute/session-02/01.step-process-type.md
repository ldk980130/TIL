# ìŠ¤í”„ë§ ë°°ì¹˜ì˜ ë‘ ê°€ì§€ ìŠ¤í… ìœ í˜•

- Spring Batchì˜ Stepì€ í¬ê²Œ ë‘ ê°€ì§€ ì²˜ë¦¬ ëª¨ë¸ë¡œ ë‚˜ë‰œë‹¤.
    - ì²­í¬ ì§€í–¥ ì²˜ë¦¬ (Chunk-Oriented Processing)
    - íƒœìŠ¤í¬ë¦¿ ì§€í–¥ ì²˜ë¦¬ (Tasklet-Oriented Processing)

## íƒœìŠ¤í¬ë¦¿(Tasklet) ì§€í–¥ ì²˜ë¦¬ëž€

- Spring Batchì—ì„œì˜ ê¸°ë³¸ì ì¸ Step êµ¬í˜„ ë°©ì‹
- ë¹„êµì  ë‹¨ìˆœí•œ ìž‘ì—… ì‹¤í–‰ì— ì‚¬ìš©ëœë‹¤.
    - ë‹¨ì¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì´ˆì ì„ ë§žì¶˜ ìž‘ì—…ë“¤
    - ex) ë§¤ì¼ ìƒˆë²½ ë¶ˆí•„ìš”í•œ ë¡œê·¸ íŒŒì¼ ì‚­ì œ
    - ex) ì™¸ë¶€ API í˜¸ì¶œ í›„ ê²°ê³¼ë¥¼ ë‹¨ìˆœížˆ ì €ìž¥í•˜ê±°ë‚˜ ë¡œê¹…
- ì´ëŸ¬í•œ ìž‘ì—…ë“¤ì€ ëŒ€ë¶€ë¶„ í•¨ìˆ˜ í˜¸ì¶œ í•˜ë‚˜ë¡œ ëë‚  ë‹¨ìˆœí•œ ìž‘ì—…ë“¤ì´ë‹¤.

```java
@FunctionalInterface
public interface Tasklet {
    @Nullable
    RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) throws Exception;
}
```

### Tasklet êµ¬í˜„ ì˜ˆì‹œ

```kotlin
private const val PROCESSED_TO_KILL: Int = 10
private var killedProcess: Int = 0

class ZombieProcessCleanupTasklet : Tasklet {
    val log: KLogger = KotlinLogging.logger {}

    override fun execute(
        contribution: StepContribution,
        chunkContext: ChunkContext,
    ): RepeatStatus {
        killedProcess += 1

        log.info { "â˜ ï¸  í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ... ({$killedProcess}/{$PROCESSED_TO_KILL})" }

        if (killedProcess >= PROCESSED_TO_KILL) {
            log.info { "ðŸ’€ ì‹œìŠ¤í…œ ì•ˆì •í™” ì™„ë£Œ. ëª¨ë“  ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ ì œê±°." }
            return RepeatStatus.FINISHED; // ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ í›„ ìž‘ì—… ì™„ë£Œ
        }

        return RepeatStatus.CONTINUABLE; // ì•„ì§ ë” ì¢…ë£Œí•  í”„ë¡œì„¸ìŠ¤ê°€ ë‚¨ì•„ìžˆìŒ
    }
}
```

- `Tasklet`ì˜ `execute` ë©”ì„œë“œëŠ” ë©”ì„œë“œ ì‹¤í–‰ì„ ê³„ì† í• ì§€ `RepeatStatus`ë¥¼ í†µí•´ ê²°ì •í•œë‹¤.

### **RepeatStatus**: FINISHED vs CONTINUALBE

- `ReapeatStatus.FINISHED`
    - `Step` ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŒì„ ì˜ë¯¸
    - `Step` ì²˜ë¦¬ê°€ ì„±ê³µì´ë“  ì‹¤íŒ¨ë“  ìƒê´€ ì—†ë‹¤.
    - ë‹¤ìŒ Stepìœ¼ë¡œ ì§„í–‰ëœë‹¤.
- `RepeatStatus.CONTINUABLE`
    - `execute` ë©”ì„œë“œê°€ ì¶”ê°€ë¡œ ì‹¤í–‰ë˜ì–´ì•¼ í•¨ì„ ì˜ë¯¸
    - Step ì¢…ë£Œê°€ ë³´ë¥˜ë˜ê³  í•„ìš”í•œ ë§Œí¼ `execute`ê°€ ë°˜ë³µ í˜¸ì¶œëœë‹¤.

### RepeatStatusê°€ í•„ìš”í•œ ì´ìœ 

- ì§§ì€ íŠ¸ëžœìž­ì…˜ì„ í™œìš©í•œ ì•ˆì „ ë°°ì¹˜ ì²˜ë¦¬
    - Spring BatchëŠ” `Tasklet`ì˜ `execute` ì‹¤í–‰ë§ˆë‹¤ ìƒˆ íŠ¸ëžœìž­ì…˜ì„ ì‹¤í–‰í•œë‹¤.
    - `RepeatStauts`ê°€ ë°˜í™˜ë˜ë©´ í•´ë‹¹ íŠ¸ëžœìž­ì…˜ì„ ì»¤ë°‹í•œë‹¤.
- `while`ë¬¸ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  `Tasklet`ê³¼ `RepeatStatus.CONTINUABLE` ë•ì— ëŒ€ëŸ‰ì˜ ë°ì´í„° ì²˜ë¦¬ ë„ì¤‘ ì¤‘ê°„ ì‹¤íŒ¨ê°€ ë°œìƒí•´ë„ ì§€ê¸ˆê¹Œì§€ì˜ ë°ì´í„°ëŠ” ì•ˆì „í•˜ë‹¤.

### Taskletì„ Stepìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ë°©ë²•

```kotlin
@Configuration
class ZombieBatchConfig(
    private val jobRepository: JobRepository,
    private val transactionManager: PlatformTransactionManager
) {
    @Bean
    fun zombieProcessCleanupTasklet(): Tasklet {
        return ZombieProcessCleanupTasklet()
    }

    @Bean
    fun zombieCleanupStep(): Step {
        return StepBuilder("zombieCleanupStep", jobRepository) // Taskletê³¼ transactionManager ì„¤ì •
            .tasklet(zombieProcessCleanupTasklet(), transactionManager)
            .build()
    }

    @Bean
    fun zombieCleanupJob(): Job {
        return JobBuilder("zombieCleanupJob", jobRepository)
            .start(zombieCleanupStep()) // Step ë“±ë¡
            .build()
    }
}
```

- ì˜ˆì œ ì½”ë“œë¥¼ ë³´ë©´ `tasklet` ì™¸ì—ë„ `PlatformTransactionManager`ê°€ ì „ë‹¬ëœë‹¤.
    - íŠ¸ëžœìž­ì…˜ ìž‘ì—…ì„ ìœ„í•´ í•„ìš”
    - ë§Œì•½ íŠ¸ëžœìž­ì…˜ì´ í•„ìš” ì—†ëŠ” ìž‘ì—…ì´ë¼ë©´ `ResourcelessTransactionManager`ë¥¼ ê³ ë ¤í•´ë³¼ ìˆ˜ ìžˆë‹¤.

```kotlin
    @Bean
    fun zombieCleanupStep(): Step =
        StepBuilder("zombieCleanupStep", jobRepository)
            .tasklet(zombieProcessCleanupTasklet(), ResourcelessTransactionManager())
            .build()
```

### Tasklet ëžŒë‹¤

- ê°„ë‹¨í•œ ìž‘ì—…ì´ë¼ë©´ `Tasklet` ë“±ë¡ ì‹œ ëžŒë‹¤ë¥¼ í†µí•´ ê°„ë‹¨ížˆ í•  ìˆ˜ ìžˆë‹¤.

```kotlin
    @Bean
    fun deleteOldRecordsStep(): Step =
        StepBuilder("deleteOldRecordsStep", jobRepository)
            .tasklet(
                Tasklet { contribution: StepContribution, chunkContext: ChunkContext ->
                    // ...
                    RepeatStatus.FINISHED
                },
                transactionManager,
            ).build()
```
