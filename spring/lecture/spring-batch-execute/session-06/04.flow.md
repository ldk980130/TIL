# Flow - 조건부 Step 실행 흐름 제어

## 순차 실행의 한계

- 지금까지의 예제는 `start()` → `next()`로 이어지는 순차 실행 방식이었다.
- 실전 환경에서는 이전 `Step`의 실행 결과(`ExitStatus`)에 따라 다음 `Step`이 달라져야 하는 경우가 있다.
  - 예: 집계 `Step` 실패 시 오류 분석 `Step`으로 분기, 파일 포맷 검증 결과에 따라 변환 처리 또는 바로 후속 처리로 분기

## Flow란?

- `Job` 안에서 각 `Step`이 어떤 조건으로 실행될지를 제어하는 메커니즘
- `Step`의 실행 결과(`ExitStatus`)에 따라 다음에 어떤 `Step`으로 진행할지를 결정

### 상태 머신(State Machine) 원리

- Flow의 동작 원리는 상태 머신과 동일
  - **상태(State)**: 각 `Step`
  - **조건**: `ExitStatus`의 `ExitCode`
  - **전이(Transition)**: 조건 충족 시 다음 `Step`으로 이동

```
              [ExitCode="COMPLETED"]
┌──────────────┐ ───────────────▶ ┌──────────────┐
│ 강의 분석      │                  │  강의 게시     │ ──▶ [작업 종료]
│   Step       │                  │   Step       │
└──────────────┘                  └──────────────┘
         │ [ExitCode="FAILED"]
         ▼
┌──────────────┐
│ 오류 처리      │ ──▶ [작업 종료]
│   Step       │
└──────────────┘
```

- `Step`(상태)에서 `ExitCode`(조건)에 따라 다음 `Step`(상태)으로 전이되는 구조

## Flow 3대 핵심 요소

### 상태(State)

- Flow 내에서 현재 실행이 머무르거나 도달할 수 있는 논리적 지점
- **실행 상태**: 실제 작업을 수행하는 지점. `StepState`, `DecisionState` 등
- **종료 상태(EndState)**: Flow 실행의 최종 도착점. 이 상태에 도달하면 Flow가 종료되며, `Job`의 최종 결과가 결정됨

### 전이 조건(ExitCode)

- `ExitStatus` 객체의 `exitCode` 필드 값이 분기 기준
- 기본 제공: `"COMPLETED"`, `"FAILED"` 등
- 커스텀 정의 가능

```java
public class ExitStatus {
    public static final ExitStatus COMPLETED = new ExitStatus("COMPLETED");
    public static final ExitStatus FAILED = new ExitStatus("FAILED");

    private final String exitCode; // 이 값이 Flow의 전이 분기를 결정
}
```

### 전이 규칙(Transition)

- `ExitCode` 조건에 따라 다음 상태로의 이동을 정의
  - 예: "`ExitCode`가 `COMPLETED`면 `publishLectureStep`으로 이동"
  - 예: "`ExitCode`가 `FAILED`면 작업을 종료(`EndState`)"

> 각 상태에서 ExitCode 결과 + 미리 정의된 Transition 규칙 = 다음 목적지 결정

> **용어 참고**: "실행 상태(Execution State)"는 Spring Batch 공식 용어가 아니라 강의에서 설명 편의를 위해 사용하는 표현이다. `EndState`가 아닌 모든 상태(`StepState`, `DecisionState` 등)를 통칭한다.

### Flow 기본 메커니즘

- Flow는 시작 상태에서 출발하여 여러 실행 상태(`StepState` 등)를 거친다
- 각 실행 상태의 `ExitCode` + 사전 정의된 `Transition` 규칙에 따라 다음 상태가 결정된다
- 이 과정을 반복하다가 최종적으로 종료 상태(`EndState`)에 도달하면 Flow가 끝난다

```
┌─────────┐    ExitCode     ┌─────────┐    ExitCode      ┌─────────┐
│ 시작 상태 │ ─────────────▶ │실행 상태1 │ ───────────────▶ │실행 상태2 │
└─────────┘  + Transition   └─────────┘   + Transition   └─────────┘
                               │                            │
                               │ ExitCode + Transition      │ ExitCode + Transition
                               ▼                            ▼
                          ┌─────────┐                  ┌──────────┐
                          │실행 상태3 │ ───────────────▶ │ 종료 상태  │
                          └─────────┘                  │(EndState)│
                                                       └──────────┘
```

- Flow DSL로 위 흐름을 구성하면 다음과 같다

```java
return new JobBuilder("conditionalJob", jobRepository)
    .start(analyzeStep)          // 시작 상태 설정
    .on("COMPLETED")             // ExitCode 조건
    .to(publishStep)             // 전이: publishStep으로 이동
    .from(analyzeStep)           // 다시 analyzeStep 기준으로
    .on("FAILED")                // ExitCode 조건
    .to(failureStep)             // 전이: failureStep으로 이동
    .end()                       // Flow 정의 종료
    .build();
```

- **`start(step)`**: Flow의 시작 상태를 설정
- **`on(exitCode)`**: 직전 상태의 `ExitCode` 조건을 지정, 조건이 일치할 때 다음 전이가 발생
- **`to(step)`**: 조건 충족 시 전이할 다음 상태를 지정. `on()`과 쌍으로 사용되어 하나의 `Transition` 규칙을 완성한다.
- **`from(step)`**: 전이의 기준점을 다시 설정. 하나의 `Step`에서 여러 `ExitCode`에 따라 각각 다른 경로로 분기할 때 사용
- **`end()`**: 모든 Flow 전이 규칙 정의가 완료

- 상태 머신의 3요소가 DSL에 다음과 같이 대응된다
  - **상태(State)**: `start()`, `to()`에 전달되는 각 `Step`이 실행 상태에 해당
  - **조건(Condition)**: `on("COMPLETED")`, `on("FAILED")` 등이 전이 발생 조건을 정의
  - **전이(Transition)**: `on()` + `to()`의 조합이 하나의 전이 규칙을 구성
