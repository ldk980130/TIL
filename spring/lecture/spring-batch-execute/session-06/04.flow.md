# Flow - 조건부 Step 실행 흐름 제어

## 순차 실행의 한계

- 지금까지의 예제는 `start()` → `next()`로 이어지는 순차 실행 방식이었다.
- 실전 환경에서는 이전 `Step`의 실행 결과(`ExitStatus`)에 따라 다음 `Step`이 달라져야 하는 경우가 있다.
  - 예: 집계 `Step` 실패 시 오류 분석 `Step`으로 분기, 파일 포맷 검증 결과에 따라 변환 처리 또는 바로 후속 처리로 분기

## Flow란?

- `Job` 안에서 각 `Step`이 어떤 조건으로 실행될지를 제어하는 메커니즘
- `Step`의 실행 결과(`ExitStatus`)에 따라 다음에 어떤 `Step`으로 진행할지를 결정

### 상태 머신(State Machine) 원리

- Flow의 동작 원리는 상태 머신과 동일
  - **상태(State)**: 각 `Step`
  - **조건**: `ExitStatus`의 `ExitCode`
  - **전이(Transition)**: 조건 충족 시 다음 `Step`으로 이동

```
              [ExitCode="COMPLETED"]
┌──────────────┐ ───────────────▶ ┌──────────────┐
│ 강의 분석      │                  │  강의 게시     │ ──▶ [작업 종료]
│   Step       │                  │   Step       │
└──────────────┘                  └──────────────┘
         │ [ExitCode="FAILED"]
         ▼
┌──────────────┐
│ 오류 처리      │ ──▶ [작업 종료]
│   Step       │
└──────────────┘
```

- `Step`(상태)에서 `ExitCode`(조건)에 따라 다음 `Step`(상태)으로 전이되는 구조

## Flow 3대 핵심 요소

### 상태(State)

- Flow 내에서 현재 실행이 머무르거나 도달할 수 있는 논리적 지점
- **실행 상태**: 실제 작업을 수행하는 지점. `StepState`, `DecisionState` 등
- **종료 상태(EndState)**: Flow 실행의 최종 도착점. 이 상태에 도달하면 Flow가 종료되며, `Job`의 최종 결과가 결정됨

### 전이 조건(ExitCode)

- `ExitStatus` 객체의 `exitCode` 필드 값이 분기 기준
- 기본 제공: `"COMPLETED"`, `"FAILED"` 등
- 커스텀 정의 가능

```java
public class ExitStatus {
    public static final ExitStatus COMPLETED = new ExitStatus("COMPLETED");
    public static final ExitStatus FAILED = new ExitStatus("FAILED");

    private final String exitCode; // 이 값이 Flow의 전이 분기를 결정
}
```

### 전이 규칙(Transition)

- `ExitCode` 조건에 따라 다음 상태로의 이동을 정의
  - 예: "`ExitCode`가 `COMPLETED`면 `publishLectureStep`으로 이동"
  - 예: "`ExitCode`가 `FAILED`면 작업을 종료(`EndState`)"

> 각 상태에서 ExitCode 결과 + 미리 정의된 Transition 규칙 = 다음 목적지 결정
