# 배치 실행 진입점과 Spring Batch 자동 구성

## JobLauncherApplicationRunner

- `./gradlew bootRun` 실행 시 배치 작업이 자동으로 실행된다.
- 커맨드라인에서 전달한 문자열을 `Job`과 `JobParameters`로 변환하여 `JobLauncher`에 전달

```
./gradlew bootRun --args='--spring.batch.job.name=brutalizedSystemJob chaos=true,java.lang.Boolean'
```

### run() 메서드

```java
public void run(ApplicationArguments args) throws Exception {
    String[] jobArguments = args.getNonOptionArgs().toArray(new String[0]);
    run(jobArguments);
}

public void run(String... args) throws JobExecutionException {
    // "="를 delimiter로 사용해 key-value Properties로 변환
    launchJobFromProperties(StringUtils.splitArrayElementsIntoProperties(args, "="));
}
```

- Spring Boot가 애플리케이션 컨텍스트 초기화 후 `run()` 메서드를 호출
- `getNonOptionArgs()`로 잡 파라미터만 추출 (예: `chaos=true,java.lang.Boolean`)
- `"="` 기준으로 `Properties`로 변환: `{ "chaos": "true,java.lang.Boolean" }`

### DefaultJobParametersConverter

- `Properties`를 실제 `JobParameters`로 변환
- 생성자에서 날짜/시간 등 다양한 타입 변환기를 등록

```java
// getJobParameters()에서 각 Properties 엔트리를 JobParameter로 변환
for (Entry<Object, Object> entry : properties.entrySet()) {
    String parameterName = (String) entry.getKey();         // "chaos"
    String encodedJobParameter = (String) entry.getValue(); // "true,java.lang.Boolean"
    JobParameter<?> jobParameter = decode(encodedJobParameter); // Boolean 타입의 true로 변환
    jobParametersBuilder.addJobParameter(parameterName, jobParameter);
}
return jobParametersBuilder.toJobParameters();
```

- `decode()` 메서드가 `"true,java.lang.Boolean"` 문자열을 분석하여 `Boolean` 타입의 `true` 값으로 변환
- 이렇게 변환된 `JobParameter`는 `JobParametersBuilder`에 전달된다.


- `JobParameters`가 준비되면 두 가지 경로로 `Job`을 실행한다.

```java
protected void launchJobFromProperties(Properties properties) throws JobExecutionException {
    JobParameters jobParameters = this.converter.getJobParameters(properties);
    executeLocalJobs(jobParameters);
    executeRegisteredJobs(jobParameters);
}
```

### executeLocalJobs()

- `@Configuration`에서 빈으로 등록한 `Job`들 중 지정된 이름과 일치하는 `Job`만 실행

```java
private void executeLocalJobs(JobParameters jobParameters) throws JobExecutionException {
    for (Job job : this.jobs) {
        if (StringUtils.hasText(this.jobName)) {
            if (!this.jobName.equals(job.getName())) {
                continue; // 이름이 일치하지 않으면 건너뜀
            }
        }
        execute(job, jobParameters);
    }
}
```

- `jobs` 변수에는 `@Autowired`를 통해 애플리케이션 컨텍스트의 모든 `Job` 타입 빈이 자동 주입

```java
// JobLauncherApplicationRunner
// ...
private Collection<Job> jobs = Collections.emptySet();

@Autowired(required = false)
public void setJobs(Collection<Job> jobs) {
    this.jobs = jobs;
}
```

- `jobName` 변수에는 `--spring.batch.job.name=brutalizedSystemJob`으로 전달한 실행할 `Job`의 이름이 설정된다.

