# 배치 실행 진입점과 Spring Batch 자동 구성

## JobLauncherApplicationRunner

- `./gradlew bootRun` 실행 시 배치 작업이 자동으로 실행된다.
- 커맨드라인에서 전달한 문자열을 `Job`과 `JobParameters`로 변환하여 `JobLauncher`에 전달

```
./gradlew bootRun --args='--spring.batch.job.name=brutalizedSystemJob chaos=true,java.lang.Boolean'
```

### run() 메서드

```java
public void run(ApplicationArguments args) throws Exception {
    String[] jobArguments = args.getNonOptionArgs().toArray(new String[0]);
    run(jobArguments);
}

public void run(String... args) throws JobExecutionException {
    // "="를 delimiter로 사용해 key-value Properties로 변환
    launchJobFromProperties(StringUtils.splitArrayElementsIntoProperties(args, "="));
}
```

- Spring Boot가 애플리케이션 컨텍스트 초기화 후 `run()` 메서드를 호출
- `getNonOptionArgs()`로 잡 파라미터만 추출 (예: `chaos=true,java.lang.Boolean`)
- `"="` 기준으로 `Properties`로 변환: `{ "chaos": "true,java.lang.Boolean" }`

### DefaultJobParametersConverter

- `Properties`를 실제 `JobParameters`로 변환
- 생성자에서 날짜/시간 등 다양한 타입 변환기를 등록

```java
// getJobParameters()에서 각 Properties 엔트리를 JobParameter로 변환
for (Entry<Object, Object> entry : properties.entrySet()) {
    String parameterName = (String) entry.getKey();         // "chaos"
    String encodedJobParameter = (String) entry.getValue(); // "true,java.lang.Boolean"
    JobParameter<?> jobParameter = decode(encodedJobParameter); // Boolean 타입의 true로 변환
    jobParametersBuilder.addJobParameter(parameterName, jobParameter);
}
return jobParametersBuilder.toJobParameters();
```

- `decode()` 메서드가 `"true,java.lang.Boolean"` 문자열을 분석하여 `Boolean` 타입의 `true` 값으로 변환
- 이렇게 변환된 `JobParameter`는 `JobParametersBuilder`에 전달된다.


- `JobParameters`가 준비되면 두 가지 경로로 `Job`을 실행한다.

```java
protected void launchJobFromProperties(Properties properties) throws JobExecutionException {
    JobParameters jobParameters = this.converter.getJobParameters(properties);
    executeLocalJobs(jobParameters);
    executeRegisteredJobs(jobParameters);
}
```

### executeLocalJobs()

- `@Configuration`에서 빈으로 등록한 `Job`들 중 지정된 이름과 일치하는 `Job`만 실행

```java
private void executeLocalJobs(JobParameters jobParameters) throws JobExecutionException {
    for (Job job : this.jobs) {
        if (StringUtils.hasText(this.jobName)) {
            if (!this.jobName.equals(job.getName())) {
                continue; // 이름이 일치하지 않으면 건너뜀
            }
        }
        execute(job, jobParameters);
    }
}
```

- `jobs` 변수에는 `@Autowired`를 통해 애플리케이션 컨텍스트의 모든 `Job` 타입 빈이 자동 주입

```java
// JobLauncherApplicationRunner
// ...
private Collection<Job> jobs = Collections.emptySet();

@Autowired(required = false)
public void setJobs(Collection<Job> jobs) {
    this.jobs = jobs;
}
```

- `jobName` 변수에는 `--spring.batch.job.name=brutalizedSystemJob`으로 전달한 실행할 `Job`의 이름이 설정된다.

### executeRegisteredJobs()

- `JobRegistry`에 등록된 `Job` 중 로컬에 없는 `Job`을 찾아 실행
- `JobRegistry`는 `Job` 전용 저장소
  - Spring Boot 자동 구성에 의해 `MapJobRegistry`(in-memory 구현체)가 사용됨

```java
private void executeRegisteredJobs(JobParameters jobParameters) throws JobExecutionException {
    if (this.jobRegistry != null && StringUtils.hasText(this.jobName)) {
        if (!isLocalJob(this.jobName)) { // 로컬 Job이 아닌 경우에만 실행
            Job job = this.jobRegistry.getJob(this.jobName);
            execute(job, jobParameters);
        }
    }
}
```

- `isLocalJob()` 검사로 로컬 컨텍스트와 `JobRegistry` 양쪽에 같은 `Job`이 있어도 중복 실행 방지
- `JobRegistry`는 동적으로 `Job`을 등록해야 할 때 유용하다.
  - 예: 애플리케이션 시작 시점에 외부 설정 파일이나 데이터베이스로부터 `Job` 정의를 읽어와 동적으로 등록하는 시나리오

### getNextJobParameters()

- `execute()` 메서드에서 `JobLauncher.run()`을 호출하기 전에 `getNextJobParameters()`로 `JobParameters`를 한 번 더 가공한다.

```java 
// execute(Job job, JobParameters jobParameters)
JobParameters parameters = getNextJobParameters(job, jobParameters);
JobExecution execution = this.jobLauncher.run(job, parameters);
// ...
```

- 상황에 따라 세 가지 분기 중 하나만 실행된다.

```java
private JobParameters getNextJobParameters(Job job, JobParameters jobParameters) {
    if (jobRepository.isJobInstanceExists(job.getName(), jobParameters)) {
        return getNextJobParametersForExisting(job, jobParameters); // 1) 이미 존재하는 JobInstance
    }
    if (job.getJobParametersIncrementer() == null) { // 2) Incrementer 없음
        return jobParameters;                                      
    }
    
    // 3) Incrementer 있음
    JobParameters nextParameters = new JobParametersBuilder(jobParameters, this.jobExplorer)
            .getNextJobParameters(job).toJobParameters();
    return merge(nextParameters, jobParameters);                 
}
```

**1) 동일한 `JobInstance`가 이미 존재하는 경우**

- 마지막 `JobExecution`이 중단/실패이고 `restartable`인 경우, 이전 `identifying` 파라미터와 새 파라미터를 병합(`merge`)
- `merge()` 시 동일한 키는 새 파라미터 값으로 덮어쓰므로, 재시작 시 `non-identifying` 파라미터를 변경할 수 있다.

**2) `JobParametersIncrementer`가 없는 경우**

- 파라미터 가공 없이 원래 `JobParameters`를 그대로 반환

**3) `JobParametersIncrementer`가 설정된 경우**

- `RunIdIncrementer` 등을 통해 이미 완료된 `JobInstance`를 동일 파라미터로 재실행할 수 있게 해준다.
- `JobExplorer`(메타데이터 저장소 읽기 전용 조회 컴포넌트)를 사용해 마지막 `JobInstance`의 실행 이력을 조회
- 이전 `JobParameters`를 `JobParametersIncrementer.getNext()`에 전달하여 증분된 파라미터를 생성한 후 기존 파라미터와 병합

### JobExplorer

- 위 3번 분기에서 사용되는 `JobExplorer`는 메타데이터 조회에 특화된 컴포넌트
- `JobRepository`는 저장/업데이트/삭제까지 담당하지만, `JobExplorer`는 오직 조회에만 집중하여 더 풍부한 조회 기능을 제공
- 배치 작업 추적 및 관리용 대시보드나 어드민 툴 개발에 유용

```java
public interface JobExplorer {
    List<JobInstance> getJobInstances(String jobName, int start, int count);
    JobInstance getLastJobInstance(String jobName);
    JobExecution getJobExecution(Long executionId);
    JobExecution getLastJobExecution(JobInstance jobInstance);
    Set<JobExecution> findRunningJobExecutions(String jobName);
    List<String> getJobNames();
    long getJobInstanceCount(String jobName);
    // ...
}
```

- 3번 분기에서는 `jobExplorer.getLastJobInstance(name)`으로 마지막 `JobInstance`를 조회한 후, 그 실행 이력의 `JobParameters`를 `JobParametersIncrementer.getNext()`에 전달한다.
- 대표적인 구현체인 `RunIdIncrementer`는 `run.id` 파라미터 값을 1씩 증가시켜 매번 새로운 `JobInstance` 생성을 보장

### execute() - JobLauncher 호출

- 최종 `JobParameters`가 결정되면 `JobLauncher.run()`을 호출하여 `Job`을 실행

```java
protected void execute(Job job, JobParameters jobParameters) {
    JobParameters parameters = getNextJobParameters(job, jobParameters);
    JobExecution execution = this.jobLauncher.run(job, parameters); // Job Squad 진입점
}
```

- 이로써 `JobLauncherApplicationRunner.run()`에서 시작하여 `JobLauncher.run()` 호출까지의 흐름이 완료된다.

## BatchAutoConfiguration

- Spring Boot의 자동 구성 메커니즘의 핵심 클래스
- Spring Boot가 Spring Batch를 감지하면 `BatchAutoConfiguration`을 자동으로 활성화시킨다.

### JobLauncherApplicationRunner 자동 구성

```java
@Bean
@ConditionalOnMissingBean
@ConditionalOnProperty(prefix = "spring.batch.job", name = "enabled", havingValue = "true", matchIfMissing = true)
public JobLauncherApplicationRunner jobLauncherApplicationRunner(JobLauncher jobLauncher, JobExplorer jobExplorer,
       JobRepository jobRepository, BatchProperties properties) {
    JobLauncherApplicationRunner runner = new JobLauncherApplicationRunner(jobLauncher, jobExplorer, jobRepository);
    String jobName = properties.getJob().getName();
    if (StringUtils.hasText(jobName)) {
       runner.setJobName(jobName);
    }
    return runner;
}
```

- `@ConditionalOnProperty(prefix = "spring.batch.job", name = "enabled", havingValue = "true", matchIfMissing = true)`
  - `spring.batch.job.enabled` 프로퍼티가 `true`인 경우 `JobLauncherApplicationRunner` 빈을 자동 등록
  - `matchIfMissing = true` 옵션으로 인해 별도로 프로퍼티를 설정하지 않아도 기본값 `true`가 적용
- 생성자에 필수 코어 컴포넌트(`JobLauncher`, `JobExplorer`, `JobRepository`)를 전달
- `properties.getJob().getName()`으로 `jobName`을 추출해 `setJobName()`에 설정
  - 앞서 `--spring.batch.job.name=brutalizedSystemJob`으로 전달한 실행할 `Job`의 이름이 여기서 설정된다.

### BatchProperties

- `BatchAutoConfiguration` 선언부에 `@EnableConfigurationProperties(BatchProperties.class)`가 선언되어 있다.
  - `application.properties`, `application.yml`, 커맨드 라인 파라미터로 전달된 설정값을 자동으로 `BatchProperties` 객체에 매핑

```java
@ConfigurationProperties(prefix = "spring.batch")
public class BatchProperties {
    private final Job job = new Job(); // spring.batch.job.*

    public static class Job {
        private String name = ""; // spring.batch.job.name
    }
    // ...
}
```

- `@ConfigurationProperties(prefix = "spring.batch")`로 `spring.batch` 접두사를 가진 설정값이 이 클래스에 매핑
- `BatchAutoConfiguration`이 `JobLauncherApplicationRunner`를 생성할 때 `properties.getJob().getName()`으로 이 값을 가져와 설정

### JobExecutionExitCodeGenerator

```java
@Bean
@ConditionalOnMissingBean(ExitCodeGenerator.class)
public JobExecutionExitCodeGenerator jobExecutionExitCodeGenerator() {
    return new JobExecutionExitCodeGenerator();
}
```

- 배치 작업의 종료 상태에 따라 애플리케이션의 종료 코드를 생성하는 컴포넌트
- 배치 작업이 실패하면 JVM이 오류 코드와 함께 종료되도록 한다.

### DefaultBatchConfiguration

```java
@Configuration(proxyBeanMethods = false)
static class SpringBootBatchConfiguration extends DefaultBatchConfiguration {
    // ...
}
```

- `BatchAutoConfiguration` 내부에 `DefaultBatchConfiguration`을 상속하는 `SpringBootBatchConfiguration` 클래스가 존재
- `DefaultBatchConfiguration`은 Spring Batch 코어 컴포넌트들의 자동 구성을 담당하는 클래스
