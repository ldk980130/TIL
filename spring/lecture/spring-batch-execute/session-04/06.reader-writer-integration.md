# ItemWriterì™€ ItemReader í†µí•©

## CompositeItemReader

- ì—¬ëŸ¬ `ItemReader`ë“¤ì„ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰
- `ItemReader`ë¥¼ `List`ë¡œ ì „ë‹¬í•˜ë©´ ì´ë¥¼ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•œë‹¤.
    - ì´ì „ `ItemReader`ê°€ ë” ì´ìƒ ì½ì„ ê²Œ ì—†ë‹¤ê³  íŒë‹¨ë˜ë©´ `null`ì„ ë°˜í™˜

```java
List<ItemStreamReader<Customer>> readers = List.of(
    shard1ItemReader,  
    shard2ItemREader   
);

CompositeItemReader<Customer> compositeReader = new CompositeItemReader<>(readers);
```

- ë°ì´í„°ë² ì´ìŠ¤ê°€ ì—¬ëŸ¬ ìƒ¤ë“œë¡œ ë¶„ì‚°ë˜ì–´ ìˆì„ ë•Œ íŠ¹íˆ ìœ ìš©í•˜ë‹¤.
  - ìƒ¤ë“œ ê´€ë¦¬ ì—†ì´ ê° ìƒ¤ë“œ(datasource)ë¥¼ ë°”ë¼ë³´ëŠ” `ItemReader`ë“¤ë§Œ ì¤€ë¹„í•˜ë©´ ëœë‹¤.

## **CompositeItemWriter**

- `CompositeItemWriter`ëŠ” ì—¬ëŸ¬ `ItemWriter`ë“¤ì—ê²Œ ê°™ì€ ë°ì´í„°ë¥¼ ì „ë‹¬í•œë‹¤.
  - ëª¨ë“  ìœ„ì„ ëŒ€ìƒë“¤ì´ ì°¨ë¡€ëŒ€ë¡œ `write()`ë¥¼ í˜¸ì¶œ

```java
public void write(Chunk<? extends T> chunk) throws Exception {
    for (ItemWriter<? super T> writer : delegates) {
       writer.write(chunk);
    }
}
```

- êµ¬ì„±ë„ ë‹¨ìˆœí•˜ë‹¤.

```java
CompositeItemWriter<Hacker> writer = new CompositeItemWriter<>(
   List.of(
       firstWriter,
       secondWriter,
       thirdWriter
   )
);
```

- í•˜ë‚˜ì˜ ë°ì´í„°ë¥¼ ì—¬ëŸ¬ ì‹œìŠ¤í…œì— ë™ì‹œì— ì¨ì•¼í•˜ëŠ” ê²½ìš° ìœ ìš©í•˜ë‹¤.
  - ex) ë™ì¼í•œ ë°ì´í„°ë¥¼ RDBì™€ NoSQLì— ê°ê° ì €ì¥í•´ì•¼ í•˜ëŠ” ê²½ìš°

- `CompositeItemWriter` ì‚¬ìš©ì—ì„  `FlatFileItemWriter`ì™€ `MongoItemWriter`ì˜ ì§€ì—° ì“°ê¸°ê°€ ë¹›ì„ ë°œí•œë‹¤.
  - `FlatFileItemWriter`ì™€ `MongoItemWriter`ëŠ” `beforeCommit()` ì‹œì ê¹Œì§€ ì‹¤ì œ ì“°ê¸°ë¥¼ ë¯¸ë£¬ë‹¤.
  - ex) `FlatFileItemWriter`, `JdbcBatchItemWriter`ë¡œ `CompositeItemWriter`ë¥¼ êµ¬ì„±í•œ ê²½ìš°
    - `JdbcBatchItemWriter`ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•œ ê²½ìš° RDBì—ì„  ìì—°ìŠ¤ë ˆ ë¡¤ë°±ì´ ì¼ì–´ë‚œë‹¤.
    - ì´ ë•Œ ì´ë¯¸ `FlatFileItemWriter.write()`ê°€ ì‹¤í–‰ë˜ì—ˆê³ , ì¦‰ì‹œ ë°ì´í„°ë¥¼ ì¼ë‹¤ë©´ íŒŒì¼ì˜ ë°ì´í„°ì™€ RDB ë°ì´í„° ì‹±í¬ëŠ” ì–´ê¸‹ë‚œë‹¤.
    - ì“°ê¸° ì§€ì—° ë•ë¶„ì— ë°ì´í„°ë¥¼ ì“°ì§€ ì•Šê³  ë„˜ì–´ê°ˆ ìˆ˜ ìˆë‹¤.

## **ClassifierCompositeItemWriter**

- `CompositeItemWriter`ì—ì„  ëª¨ë“  `ItemWriter`ë“¤ì´ ê°™ì€ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•´ì•¼ í•œë‹¤.
- `ClassifierCompositeItemWriter`ëŠ” ì—¬ëŸ¬ ë°ì´í„°ë“¤ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
  - Springì˜ `Classifier`ë¥¼ ì‚¬ìš©í•´ ë°ì´í„°ë¥¼ ë¶„ê¸°
  - `write()` ë©”ì„œë“œì— ì²­í¬ê°€ ì „ë‹¬ë˜ë©´ `classify()` ë©”ì„œë“œê°€ ë™ì‘
  - ê° ë°ì´í„° ì²˜ë¦¬ ë°©ì‹ì— ë”°ë¼ ìœ„ì„ `ItemWriter`ê°€ ì„ íƒëœë‹¤.

```java
// ClassifierCompositeItemWriter ë‚´ë¶€ì˜ classifier í•„ë“œ
private Classifier<T, ItemWriter<? super T>> classifier = new ClassifierSupport<>(null);
```

### êµ¬ì„± ë°©ë²•

- `ClassifierCompositeItemWriter` êµ¬ì„±í•˜ëŠ” ë‘ ê°€ì§€ ë°©ë²•
  - `ClassifierCompositeItemWriter` ê°ì²´ ìƒì„± í›„ `setClassifer()`ë¡œ ë¶„ë¥˜ê¸° ì„¤ì •
  - `ClassifierCompositeItemWriterBuilder.classifier()`ë¡œ í•œ ë²ˆì˜ ì„¤ì •

### ì˜ˆì œ ì½”ë“œ

```kotlin
    class SystemLogClassifier(
        private val criticalWriter: ItemWriter<SystemLog>,
        private val normalWriter: ItemWriter<SystemLog>,
    ) : Classifier<SystemLog, ItemWriter<in SystemLog>> {
        companion object {
            const val CRITICAL_CPU_THRESHOLD = 90
            const val CRITICAL_MEMORY_THRESHOLD = 1024L * 1024 * 1024 // 1GB
        }

        override fun classify(log: SystemLog): ItemWriter<in SystemLog> =
            if (isCritical(log)) {
                criticalWriter
            } else {
                normalWriter
            }

        private fun isCritical(log: SystemLog): Boolean =
            log.type == "CRITICAL" ||
                log.cpuUsage >= CRITICAL_CPU_THRESHOLD ||
                log.memoryUsage >= CRITICAL_MEMORY_THRESHOLD
    }
```

```kotlin
    @Bean
    fun classifierWriter(): ClassifierCompositeItemWriter<SystemLog> =
        ClassifierCompositeItemWriter<SystemLog>()
            .apply {
                setClassifier(
                    SystemLogClassifier(
                        criticalLogWriter(),
                        normalLogWriter(),
                    ),
                )
            }

    @Bean
    fun normalLogWriter(): ItemWriter<SystemLog> =
        ItemWriter { items ->
            log.info { "âœ…NormalLogWriter: ì¼ë°˜ ë¡œê·¸ ì²˜ë¦¬ ì¤‘... ëŒ€ì¶© íŒŒì¼ì— ì¶œë ¥í•˜ê±°ë‚˜ í•˜ì.." }
            items.forEach { item ->
                log.info { "âœ…ì¼ë°˜ ì²˜ë¦¬: $item" }
            }
        }

    @Bean
    fun criticalLogWriter(): ItemWriter<SystemLog> =
        ItemWriter { items ->
            log.info { "ğŸš¨CriticalLogWriter: ì¹˜ëª…ì  ì‹œìŠ¤í…œ ë¡œê·¸ ê°ì§€! ì¦‰ì‹œ ì²˜ë¦¬ ì‹œì‘!" }
            items.forEach { item ->
                // ì‹¤ì œ ìš´ì˜ì—ì„  ì—¬ê¸°ì„œ ìŠ¬ë™ í˜¹ì€ ì´ë©”ì¼ ë°œì†¡
                log.info { "ğŸš¨ê¸´ê¸‰ ì²˜ë¦¬: $item" }
            }
        }
```

