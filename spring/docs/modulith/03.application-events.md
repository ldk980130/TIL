# 03. Working with Application Events

https://docs.spring.io/spring-modulith/reference/events.html

- 애플리케이션 모듈을 가능한 분리된 상태로 유지하려면 이벤트를 주요 상호 작용 수단으로 사용해야 한다.

```kotlin
@Service
class OrderManagement(val inventory: InventoryManagement) {

  @Transactional
  fun complete(order: Order) {
    inventory.updateStockFor(order)
  }
}
```

- 위의 `complete()` 메서드는 다른 애플리케이션 모듈에 정의된 스프링 빈과 상호 작용하고 있다.
    - 특히 `OrderManagement` 인스턴스를 생성하기 위해 의존하는 빈이 필요하기에 테스트하기 까다로워진다.
- 또한 비즈니스 이벤트인 주문 완료에 추가 기능을 통합하고 싶을 때마다 위 클래스를 수정해야한다.
- 이러한 문제를 방지하기 위해 아래처럼 이벤트를 사용할 수 있다.
    - 다른 스프링 빈에 직접 의존하는 대신 도메인 이벤트를 발행

```kotlin
@Service
class OrderManagement(val events: ApplicationEventPublisher, val dependency: OrderInternal) {

  @Transactional
  fun complete(order: Order) {
    events.publishEvent(OrderCompleted(order.id))
  }
}
```

- 이벤트 발행은 기본적으로 동기적으로 일어나기에 트랜잭션의 범위는 동일하게 유지된다.
- 여러 애플리케이션 모듈 간의 일관성 모델을 간단하게 얻을 수 있다는 장점도 있지만 한 모듈의 에러로 전체 트랜잭션이 실패할 수도 있다는 단점도 있다.
- 이벤트 발행을 트랜잭션을 분리하여 처리할 수도 있다.
    - 커밋 시 이벤트 소비 + 비동기
    - 하지만 이 방법은 이벤트 소비가 실패 시 안전망이 없다면 이벤트 발행이 손실되는 위험도 발생한다.

```kotlin
@Component
class InventoryManagement {

  @Async
  @TransactionalEventListener
  fun on(event: OrderCompleted) { /* … */ }
}
```

## Application Module Listener

- 커밋 후 이벤트를 소비하면서 새로운 트랜잭션을 사용하려면 아래처럼 사용해야 한다.

```kotlin
@Component
class InventoryManagement {

  @Async
  @Transactional(propagation = Propagation.REQUIRES_NEW)
  @TransactionalEventListener
  fun on(event: OrderCompleted) { /* … */ }
}
```

- Spring Modulith는 위 세 애너테이션을 한 번에 적용하는 `@ApplicationModuleListener`를 제공한다.

```kotlin
@Component
class InventoryManagement {

  @ApplicationModuleListener
  fun on(event: OrderCompleted) { /* … */ }
}
```

## The Event Publication Registry

- Spring Modulith는 스프링 프레임워크의 핵심 이벤트 발행 메커니즘에 연결되는 이벤트 발행 레지스트리와 함께 제공된다.
- 이벤트를 발행하면 이벤트를 전달 받을 트랜잭션 이벤트 리스너를 찾아 각 리스너에 대한 항목을 원리 비즈니스 트랜잭션의 일부로 이벤트 발행 로그에 기록한다.

![image](https://github.com/user-attachments/assets/039541ea-5c0c-4b32-97a0-ffc06e2befe7)

- 각 트랜잭션 이벤트 리스너는 실행이 성공하면 해당 로그 항목을 완료된 것으로 처리한다.
    - 리스너가 실패하는 경우에도 로그는 유지되기에 애플리케이션 필요에 따라 재시도 메커니즘을 배포할 수도 있다.
    - 기본적으로 모든 불완전한 이벤트 발행이 애플리케이션 시작시 다시 제출된다.

![image](https://github.com/user-attachments/assets/7bcfbae8-df23-44b6-81ec-3fc7c1ed591a)

### Spring Boot Event Registry Starters

- 트랜잭션 이벤트 발행 로그를 사용하려면 애플리케이션에 추가한 아티팩트의 조합이 필요하다.
- Spring Modulith는 사용할 영속성 기술을 중심으로 하는 스타터 종속성을 제공한다.
    - `spring-modulith-starter-jpa`
    - `spring-modulith-starter-jdbc`
    - `spring-modulith-starter-mongodb`
    - `spring-modulith-starter-neo4j`
