# Chapter5 스프링 데이터 JPA를 이용한 조회 기능
## 5.1 시작에 앞서

- CQRS란 명령(Command) 모델과 조회(Query) 모델을 분리하는 패턴이다.
    - 명령 모델은 상태를 변경하는 기능
    - 조회 모델은 데이터를 조회하는 기능
    - 엔티티, 애그리거트, 리포지터리 등의 모델은 명령 모델에 주로 사용된다.
- 조회 모델을 구현할 때 JPA, 마이바티스, JdbcTemplate 등 다양한 DB 연동 기술을 사용할 수 있다.

## 5.3 스프링 데이터 JPA를 이용한 스펙 구현

- 검색 조건이 고정되어 있다면 단순하게 특정 조건으로 조회하는 기능을 만들면 된다.
- 하지만 다양한 검색 조건을 조합해야 한다면 `find` 메서드가 너무 많이 증가하게 될 것이다.
- 검색 조건을 다양하게 조합해야 할 때 스펙(specification)을 사용할 수 있다.

```java
public interface Specification<T> {
  public boolean isSatisfiedBy(T agg);
}
```

- `isSatisfiedBy()`의 `agg`는 검사 대상 객체다.
    - 레포지터리에 사용하면 애그리거트 루트가 되고 DAO에 사용히면 검색결과로 리턴할 데이터 객체가 된다.

## 5.3 스프링 데이터 JPA를 이용한 스펙 구현

- 스프링 데이터 JPA는 `Specification` 인터페이스를 제공한다.

```java
public interface Specification<T> extends Serializable {
  @Nullable
  Predicate toPredicate(Root<T> root, 
                       CriteriaQuery<?> query,
                       CriteriaBuilder cb);
}
```

- `toPredicate` 메서드는 JPA 크리테리아 API에서 조건을 표현하는 `Predicate`를 생성한다.
    - 아래 예제는 `orderId`가 동일한지 비교하는 `Predicate`를 생성한다.

```java
public class OrderIdSpec implements Specification<OrderSummary> {

    private String orderId;
    
    public OrderIdSpec(String orderId) {
      this.orderId = orderId
    }
    
    @Override
    public Predicate toPredicate(Root<OrderSummary> root,
                                CriteriaQuery<?> query,
                                CriteriaBuilder cb) {
        return cb.equal(root.get(OrderSummary.orderId), orderId);
    }                                
}
```

## 5.4 리포지터리/DAO 스펙 사용하기

- 스펙을 충족하는 엔티티를 검색하고 싶다면 findAll 메서드를 사용하면 된다.

```java
public interface OrderSummaryDao extends Repository<OrderSummary, String> {
  List<OrderSummary> findAll(Specification<OrderSummary> spec);
}
```

## 5.5 스펙 조합

- 스펙 인터페이스에는 스펙을 조합할 수 있는 두 메서드를 제공한다.

```java
public interface Specification<T> extends Serializable {

  default Specification<T> and(@Nullable Specification<T> other) { ... }
  default Specification<T> or(@Nullable Specification<T> other) { ... }

  @Nullable
  Predicate toPredicate(Root<T> root, 
                       CriteriaQuery<?> query,
                       CriteriaBuilder cb);
}
```

- `spec1.and(spec2)`와 같이 작성하면 두 스펙 모두 충족하는 표현을 생성한다.
- 조건을 반대로 적용하는 `not()` 메서드도 존재한다.
- `where()` 메서드를 사용하면 `null` 사용 시 아무 조건도 생성하지 않는 스펙을 생성한다.

## 5.6 정렬 지정하기

- 스프링 데이터 JPA를 쓴다면 메서드 이름으로 정렬 조건을 명시할 수 있다.
    - ex) `findBy…OrderByNumberDesc()`
- 정렬 조건이 복잡하다면 `Sort` 객체를 사용할 수 있다.

```java
Sort sort = Sort.by("number").ascending()
List<OrderSummary> results = orderSummaryDao.findByOrderId(String orderId, Sort sort)
```

- `Sort`도 `and`나 `or`로 조건을 연결할 수 있다.
    - `sort1.and(sort2)`

## 5.7 페이징 처리하기

- `Pageable` 인터페이스로 페이징 처리를 할 수 있다.
    - `PageRequest` 클래스로 `Pageable` 타입을 생성할 수 있다.
- `PageRequest`와 `Sort`를 함께 사용할 수도 있다.

```java
Sort sort = Sort.by("name").descending()
PageRequest req = PageRequest.of(1, 10, sort);
List<MemberData> user = memberDataDao.findByNameLike("...%", req)
```
