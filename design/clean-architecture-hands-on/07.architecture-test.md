# 07. 아키텍처 요소 테스트하기

## 테스트 피라미드

![image](https://github.com/ldk980130/TIL/assets/78652144/3f602401-6538-4cbd-b656-c6da52c41c0a)

- 단위 테스트가 가장 높은 커버리지를 유지해야 한다.
    - 만드는 비용이 적고 유지보수하기 쉽고 빨리 실행되고 안정적이기 때문
- 통합 테스트로 넘어가면 테스트 비용이 비싸지고 실행이 느려지고 깨지기 쉬워진다.
- 테스트 피라미드는 테스트가 비싸질수록 커버리지 목표를 낮게 잡아야 한다는 것을 보여준다.
    - 그렇지 않으면 기능 구현보다 테스트를 만드는 데 시간을 더 쓰게 된다.
- 단위 테스트는 일반적으로 하나의 클래스를 인스턴스화하고 해당 클래스의 인터페이스를 통해 테스트한다.
- 통합 테스트는 여러 유닛을 인스턴스화하여 시작점이 되는 클래스의 인터페이스로 테스트한다.
    - 유닛들의 네트워크를 검증
    - 여러 계층 간 경계를 걸쳐 테스트하기에 때로는 목을 사용할 수도 있다.
- 시스템 테스트는 애플리케이션을 구성하는 모든 객체 네트워크를 가동시켜 특정 유스케이스가 전 계층에서 잘 동작하는지 검증한다.

## 단위 테스트로 도메인 엔티티 테스트하기

- 도메인 엔티티를 대상으로 단위 테스트를 진행할 수 있다.
    - [AccouintTest 예제 코드](https://github.com/ldk980130/clean-architecture-hands-on/blob/main/src/test/java/com/practice/cleanarichitecturehandson/buckpal/account/domain/AccountTest.java)
- 단위 테스트는 만들기 쉽고 빠르게 실행된다.
- 도메인 엔티티의 행동은 다른 클래스에 거의 의존하지 않기에 다른 종류의 테스트는 필요하지 않다.

## 단위 테스트로 유스케이스 테스트하기

- 유스케이스를 테스트하는 것도 단위 테스트라고 할 수도 있다.
    - 의존성의 상호작용을 테스트하고 있기에 통합 테스트라고도 볼 수 있지만 목으로 작업하고 있기에 단위 테스트라고도 볼 수 있다.
- [SendMoneyServiceTest 예제 코드](https://github.com/ldk980130/clean-architecture-hands-on/blob/main/src/test/java/com/practice/cleanarichitecturehandson/buckpal/account/application/service/SendMoneyServiceTest.java)
    - 테스트 중인 유스케이스는 상태가 없기에 모킹된 의존 대상과의 상호작용 여부를 테스트한다. (행위 검증)
    - 행위 검증을 하게 되면 리팩터링 시 테스트가 깨지기 쉬워지기 때문에 모든 동작이 아닌 핵심 동작만 골라 테스트하는 것이 좋다.

## 통합 테스트로 웹 어댑터 테스트하기

- 웹 어댑터는 HTTP를 통해 JSON 등을 입력 받고 입력 유효성을 검증한 뒤 유스케이스에서 사용할 수 있는 포맷으로 매핑한 뒤 유스케이스에 전달한다.
- [SendMoneyControllerTest 예제 코드](https://github.com/ldk980130/clean-architecture-hands-on/blob/main/src/test/java/com/practice/cleanarichitecturehandson/buckpal/account/adapter/in/web/SendMoneyControllerTest.java)
    - 웹 어댑터의 책임 대부분은 이런 테스트로 커버된다.
- `@WebMvcTest`는 HTTP 입력 검증, 자바와 JSON 간 매핑 등의 객체 네트워크를 인스턴스화하도록 만들고 이 네트워크의 일부로서 컨트롤러가 잘 동작하는지 테스트한다. → 통합 테스트
    - 만약 컨트롤러를 단위 테스트로 만들면 모든 매핑, 유효성 검증, HTTP 항목에 관한 커버리지가 낮아진다.
    - 애초에 컨트롤러는 스프링 프레임워크와 결합이 강하기 때문에 통합 테스트로 만드는 것이 합리적이다.
