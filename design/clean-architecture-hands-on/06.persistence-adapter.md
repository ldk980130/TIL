# 06. 영속성 어댑터 구현하기

## 의존성 역전하기

![image](https://github.com/ldk980130/TIL/assets/78652144/feae957f-1f5a-4bdb-bf15-4d1dcc5657dd)

- 애플리케이션 서비스에서 영속성 기능을 사용하기 위해 포트 인터페이스를 호출한다.
    - 포트 인터페이스는 영속성 어댑터 클래스에서 구현된다.
- 육각형 아키텍처에서 영속성 어댑터는 ‘주도되는’, ‘아웃고잉’ 어댑터다.
    - 호출될 뿐 호출하지는 않기 때문
- 포트는 애플리케이션 계층과 영속성 계층을 격리하기 위한 간접 계층이다.
    - 영속성 코드를 리팩터링해도 애플리케이션 코드에 영향을 주지 않는다.
- 런타임 의존성은 애플리케이션 → 영속성이기 때문에 영속성의 버그가 애플리케이션에 영향을 줄 수는 있다.
    - 다만 포트가 계약을 만족하는 한 애플리케이션 계층에 영향을 주지 않으면서 영속성 계층을 마음껏 수정할 수 있다.

## 영속성 어댑터의 책임

1. 입력을 받는다
    - 입력 모델은 인터페이스가 지정한 도메인 엔티티나 특정 DB 연산 전용 객체
    - 입력 모델은 코어 계층에 위치하기 때문에 어댑터 내부의 변경이 코어에 영항을 미치지 않는다
2. 입력을 데이터베이스 포맷으로 매핑
    - 자바에서는 일반적으로 JPA를 사용
    - JPA로 매핑하지 않을 수도 있다.
3. 입력을 데이터베이스로 보낸다
4. 데이터베이스 출력을 애플리케이션 포맷으로 매핑
5. 출력 반환

## 포트 인터페이스 나누기

- 단순한 아키텍처에서 특정 엔티티가 필요로 하는 모든 DB 연산을 하나의 리포지토리 인터페이스에 넣어 두는 게 일반적인 방법이다.

  ![image](https://github.com/ldk980130/TIL/assets/78652144/422aa34b-c2ef-45ec-838b-6736a12c2b8e)

    - 각 서비스는 인터페이스에서 단 하나의 메서드만 사용하더라도 ‘넓은’ 포트 인터페이스에 의존성을 갖게 된다.
    - 맥락 안에서 필요하지 않은 메서드에 대한 의존성은 코드를 이해하고 테스트하기 어렵게 만든다.
    - 테스트를 위해 모킹을 수행할 때 어떤 메서드를 모킹해야 하는지 찾기 힘들 수 있고 다른 작업자가 인터페이스 전체가 모킹되었다고 착각할 수도 있다.
- 혼란을 피하기 위해 인터페이스 분리 원칙 필요하다.

  ![image](https://github.com/ldk980130/TIL/assets/78652144/1d82ab0a-b958-4c56-920f-92db2dc17758)

    - 이제 각 서비스는 실제로 필요한 메서드에만 의존한다.
    - 포트 이름이 포트의 역할을 잘 표현하고 있다.
    - 매우 좁은 포트를 만드는 것은 코딩을 플로그 앤드 플레이(plug-and-play) 경험으로 만든다.
        - 재설정하거나 조정하는 과정 없이 연결하는 즉시 완벽하게 동작하는 방식
    - 물론 모든 상황에서 ‘포트 하나당 하나의 메서드’를 적용할 수는 없고 응집성이 높은 메서드들은 묶일 수도 있다.

## 영속성 어댑터 나누기

영속성 포트를 구현하는 어댑터는 어떻게 나눠야할까?

- 하나의 방법은 도메인 주도 개발에서의 ‘애거리거트’ 하나당 하나의 영속성 어댑터를 구현하는 것이다.

  ![image](https://github.com/ldk980130/TIL/assets/78652144/64c383e5-87d4-41f4-8b4e-75edfb68391a)

    - 영속성 어댑터들은 도메인 경계를 따라 자동으로 나눠진다.
    - ‘애그리거트당 하나의 영속성 어댑터’는 여러 바운디드 컨텍스트의 영속성 요구사항을 분리하기 위한 좋은 토대가 된다.
- 영속성 어댑터를 상황에 따라 훨씬 더 많은 클래스로 나눌 수도 있다.
- [AccountPersistenceAdapter 코드 예제](https://github.com/ldk980130/clean-architecture-hands-on/blob/main/src/main/java/com/practice/cleanarichitecturehandson/buckpal/account/adapter/out/persistence/AccountPersistenceAdapter.java)

