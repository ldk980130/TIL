# 5장 지표 모니터링 및 경보 시스템
## 1단계: 문제 이해 및 설계 범위 확정

- 대규모 인프라를 모니터링 해야 함
    - DAU 1억명
    - 서버 풀 1,000개, 풀당 서버 수 100개
    - 데이터 보관 기간은 1년
    - 수집한 그대로 데이터를 일주일 간 보관 후 그 뒤에는 1분 단위 데이터로 변환 후에 30일간 보관 후 그 뒤에는 1시간 단위 데이터로 변환 뒤에 1년 간 보관
- 모니터링할 지표
    - CPU 사용률
    - 요청 수
    - 메모리 사용량
    - 메시지 큐 내의 메시지 수
- 비기능 요구사항
    - 규모 확장성: 시스템은 늘어나는 지표에 맞게 확장될 수 있어야 한다.
    - 낮은 응답 지연: 경보(alert)를 신속하게 대처할 수 있도록 낮은 응답을 보장해야 한다.
    - 안정성: 중요 경보를 놓치지 않아야 한다.
    - 유연성: 미래의 신기술을 쉽게 통합할 수 있도록 유연하게 변경 가능한 파이프라인을 구축해야 한다.

## 2단계: 계략적 설계안 제시 및 동의 구하기

- 지표 모니터링 및 경보 시스템은 다음 다섯 컴포넌트를 이용한다.
    - 데이터 수집: 여러 출처로부터 지표를 수집
    - 데이터 전송: 지표 데이터를 모니터링 시스템으로 전송
    - 데이터 저장소: 전송된 데이터를 정리 및 저장
    - 경보(alert): 데이터를 분석하고 이상 징후를 감지하여 경보를 발생시키는데 다양한 통신 채널로 발송할 수 있어야 한다.
    - 시각화: 지표를 차트나 그래프 등으로 제공한다.

### 데이터 모델

- 지표 데이터는 보통 시계열(time series) 데이터 형태로 기록한다.
    - 값 집합에 타임스탬프가 붙은 형태
    - 시계열 각각에 고유한 이름이 붙고 선택적으로 레이블(label)을 붙이기도 한다.
- 많은 모니터링 소프트웨어가 시계열 데이터를 구성할 때 아래 형식을 준수한다.

| 이름 | 자료형 |
| --- | --- |
| 지표 이름 | 문자열 |
| 태그/레이블 집합 | <키:값> 쌍의 리스트(List) |
| 지표 값 및 그 타임스탬프의 배열 | <값, 타임스탬프> 쌍의 배열(Array |

- ex) 만약 특정 서버 인스턴스의 20:00 시점의 CPU 부하를 알고 싶은 경우
    - 아래 데이터는 지표 이름 레이블, 지표 데이터로 구성되어 있다.

| metric_name | cpu.load |
| --- | --- |
| labels | host:i631,env:prod |
| timestamp | 1613707265 |
| value | 0.29 |

- ex) 지난 10분간 us-west 지역에 위치한 모든 웹 서버의 CPU 부하 평균을 알고 싶은 경우 지표 이름이 CPU.load이고 레이블에 포함된 지역 이름이 us-west인 데이터들로 평균을 구하면 된다.
    - `CPU.load host=webserver01,region=us-west 1613707265 50`

- 로그 데이터 접근 패턴
  - 일반적인 웹 애플리케이션과 달리 읽기 부하보다 쓰기 부하가 더 막대하다.
  - 읽기 부하는 일시적으로 치솟았다 사라지는 편이다.

### 데이터 저장소 시스템

- 일반적인 관계형 데이터베이스는 시계열 데이터 처리가 가능하긴 하지만 부하 규모에 맞추려면 전문가 수준의 튜닝이 필요하다.
  - 관계형 DB는 시계열 데이터에 최적화되어 있지도 않다.
- 카산드라 같은 NoSQL은 관계형 보다는 낫지만 시계열 데이터를 위한 스키마를 설계하려면 NoSQL에 대한 새박한 지식이 필요하다.
- 시장에는 잘 최적화된 시계열 데이터 저장소 시스템이 많다.
  - OpenTSDB는 분산 시계열 데이터베이스이지만 하둡과 HBase 기반이기에 하둡/HBase 클러스터를 운영해야 해서 복잡하다.
  - X(구 트위터)는 MetricsDB를 사용한다.
  - 아마존은 타임스트림(Timestream)이라는 제품을 출시했다.
- DB-engins에서 조사한 결과 가장 인기 있는 시계열 데이터베이스 두 가지는 InfluxDB와 프로메테우스(Prometheus)이다.
  - 다량의 시계열 데이터를 저장, 실시간 분석하는 것이 가능
  - 메모리 캐시와 디스크 저장소를 함께 사용하여 영속성 요건도 잘 만족한다.
  - 8CPU 코어와 32GB 램을 갖춘 Influx 한 대로 초당 250,000회 쓰기 연산 처리가 가능하다고 한다.
- 좋은 시계열 데이터베이스는 대량의 시계열 데이터를 레이블 기준으로 집계, 분석하는 기능을 제공한다.
  - InfluxDB의 경우 이를 지원하기 위해 레이블 별 인덱스를 구축한다.
  - 핵심은 각 레이블이 가질 수 있는 값의 가짓수가 낮아야 한다.
