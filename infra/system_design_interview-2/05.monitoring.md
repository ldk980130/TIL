# 5장 지표 모니터링 및 경보 시스템
## 1단계: 문제 이해 및 설계 범위 확정

- 대규모 인프라를 모니터링 해야 함
    - DAU 1억명
    - 서버 풀 1,000개, 풀당 서버 수 100개
    - 데이터 보관 기간은 1년
    - 수집한 그대로 데이터를 일주일 간 보관 후 그 뒤에는 1분 단위 데이터로 변환 후에 30일간 보관 후 그 뒤에는 1시간 단위 데이터로 변환 뒤에 1년 간 보관
- 모니터링할 지표
    - CPU 사용률
    - 요청 수
    - 메모리 사용량
    - 메시지 큐 내의 메시지 수
- 비기능 요구사항
    - 규모 확장성: 시스템은 늘어나는 지표에 맞게 확장될 수 있어야 한다.
    - 낮은 응답 지연: 경보(alert)를 신속하게 대처할 수 있도록 낮은 응답을 보장해야 한다.
    - 안정성: 중요 경보를 놓치지 않아야 한다.
    - 유연성: 미래의 신기술을 쉽게 통합할 수 있도록 유연하게 변경 가능한 파이프라인을 구축해야 한다.

## 2단계: 계략적 설계안 제시 및 동의 구하기

- 지표 모니터링 및 경보 시스템은 다음 다섯 컴포넌트를 이용한다.
    - 데이터 수집: 여러 출처로부터 지표를 수집
    - 데이터 전송: 지표 데이터를 모니터링 시스템으로 전송
    - 데이터 저장소: 전송된 데이터를 정리 및 저장
    - 경보(alert): 데이터를 분석하고 이상 징후를 감지하여 경보를 발생시키는데 다양한 통신 채널로 발송할 수 있어야 한다.
    - 시각화: 지표를 차트나 그래프 등으로 제공한다.

### 데이터 모델

- 지표 데이터는 보통 시계열(time series) 데이터 형태로 기록한다.
    - 값 집합에 타임스탬프가 붙은 형태
    - 시계열 각각에 고유한 이름이 붙고 선택적으로 레이블(label)을 붙이기도 한다.
- 많은 모니터링 소프트웨어가 시계열 데이터를 구성할 때 아래 형식을 준수한다.

| 이름 | 자료형 |
| --- | --- |
| 지표 이름 | 문자열 |
| 태그/레이블 집합 | <키:값> 쌍의 리스트(List) |
| 지표 값 및 그 타임스탬프의 배열 | <값, 타임스탬프> 쌍의 배열(Array |

- ex) 만약 특정 서버 인스턴스의 20:00 시점의 CPU 부하를 알고 싶은 경우
    - 아래 데이터는 지표 이름 레이블, 지표 데이터로 구성되어 있다.

| metric_name | cpu.load |
| --- | --- |
| labels | host:i631,env:prod |
| timestamp | 1613707265 |
| value | 0.29 |

- ex) 지난 10분간 us-west 지역에 위치한 모든 웹 서버의 CPU 부하 평균을 알고 싶은 경우 지표 이름이 CPU.load이고 레이블에 포함된 지역 이름이 us-west인 데이터들로 평균을 구하면 된다.
    - `CPU.load host=webserver01,region=us-west 1613707265 50`
