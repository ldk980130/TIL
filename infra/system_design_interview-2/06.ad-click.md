# 6장 광고 클릭 이벤트 집계
- 온라인 광고의 핵심은 실시간 데이터를 통해 광고 효과를 정량적으로 측정할 수 있다는 점이다.
- 디지털 광고의 핵심 프로세스는 RTB(Real-Time Bidding)이다.
    - 즉 실시간 경매로 광고가 나갈 지면을 거래한다.
    - RTB 프로세스는 속도가 중요하다. (1초 내에 마무리되어야 함)
- 광고 클릭 이벤트 집계는 온라인 광고가 얼마나 효율적이었는지 측정하는 데 결정적 역할을 한다.
    - CTR(Click-Through Rate, 클릭률)
    - CVR(Conversion Rate, 전환률)

## 1단계: 문제 이해 및 설계 범위 확정

- 기능 요구사항
    - 지난 M분 동안의 ad_id 클릭 수 집계
    - 매분 가장 많이 클릭된 상위 100개 광고 아이디 반환
    - 다양한 집계 필터링 지원
    - 데이터 양은 페이스북이나 구글 규모
- 비기능 요구사항
    - 집계 결과 정확성은 데이터가 RTB 및 광고 과금에 사용되므로 중요
    - 지연되거나 중복된 이벤트를 적절히 처리해야 함
    - 부분적 장애는 감내할 수 있어야 함
    - 전체 처리 시간은 최대 수 분을 넘지 않아야 함
- 개략적 추정
    - DAU 10억 명
    - 각 사용자는 하루에 평균 1개 광고를 클릭한다고 가정 (하루 10억건 클릭 발생)
    - 광고 클릭 QPS = 10,000
    - 최대 광고 클릭 QPS는 다섯 배라 가정
    - 클릭 이벤트 하나당 0.1KB 용량이 필요하다고 가정함 (0.1KB * 10억 = 100GB, 월간 용량 요구량 대략 3TB)

## 2단계: 개략적 설계안 제시 및 동의 구하기

### 질의 API 설계

- API는 2개 있으면 된다.
    - 지난 M분간 각 ad_id에 발생한 클릭 수 집계 API
    - 지난 M분간 가장 많은 클릭이 발생한 상위 N개 ad_id 목록

### 데이터 모델

- 데이터는 원시 데이터와 집계 결과 데이터 두 종류로 나눌 수 있다.
- 원시 데이터
    - ex) `[AdClickEvent] ad001, 2021-01-01 00:00:01, user 1, 207.148.22.22, USA`
    - 원시 데이터는 여러 애플리케이션 서버에 산재해 있다.
- 집계 결과 데이터
    - 아래는 분당 집계를 기록한 예시이다.

| ad_id | click_minute | count |
| --- | --- | --- |
| ad001 | 202101010000 | 5 |
| ad001 | 202101010001 | 7 |

- 원시 데이터와 집계 데이터 둘 다 저장하는 것이 좋다.
    - 원시 데이터는 문제 발생 시 디버깅 용도로 활용할 수 있다.
    - 원시 데이터는 양이 엄청나므로 직접 질의는 비효율적이기에 집계 데이터에 질의하는 것이 바람직하다.
    - 원시 데이터는 백업 데이터로 활용된다.
    - 집계 결과 데이터는 활성 데이터 구실을 하고 성능을 위해 튜닝하는 것이 보통이다.

### 올바른 데이터베이스의 선택

- 원시 데이터는 일상 작업에선 필요 없지만 데이터 분석에는 유용하다.
  - 원시 데이터는 쓰기가 압도적이고 읽기는 백업과 재계산 용도로만 이용된다.
  - 이정도 규모의 쓰기는 관계형 보단 카산드라나 InfluxDB를 사용하는 것이 바람직하다.
- 집계 데이터는 본질적으로 시계열 데이터이며 읽기/쓰기 둘 다 많이 사용한다.
  - 각 광고마다 매 분마다 질의를 던져 고객에게 최신 집계 결과를 제시해야 한다.
  - 집계 서비스가 데이터를 매 분 집계하고 결과를 기록하므로 쓰기도 빈번하다.
- 원시 데이터와 집계 데이터는 같은 유형의 데이터베이스를 활용하는 것이 가능하다.
