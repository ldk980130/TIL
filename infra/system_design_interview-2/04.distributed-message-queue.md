# 4장 분산 메시지 큐
- 메시지 큐 사용의 이점
    - 결합도 완화(decoupling)
    - 규모 확장성 개선: 소비자 시스템 규모를 트래픽 부하에 맞춰 독립적으로 늘릴 수 있다.
    - 가용성 개선: 특정 컴포넌트에 장애가 발생해도 다른 컴포넌트는 서비스를 계속할 수 있다.
    - 성능 개선: 메시지 큐를 통해 비동기 통신이 쉽게 가능하고 생산자와 소비자는 서로를 기다릴 필요가 없다.

### 메시지 큐 대 이벤트 스트리밍 플랫폼

- 아파치 카프카(Kafaka)나 펄사(Pulsa)는 엄밀히 말하면 메시지 큐가 아닌 이벤트 스트리밍 플랫폼이다.
    - 데이터 장기 보관, 메시지 반복 소비 등의 부가 기능은 통상적으로 이벤트 스트리밍 플랫폼에서만 이용 가능하다.
- 하지만 메시지 큐(RocketMQ, RabbitMQ 등)의 기능이 점점 확장되며 경계가 점차 희미해지고 있다.
    - ex) RabbitMQ에서 반복적으로 소비 가능하고, 장기 보관이 가능한 스트리밍 기능이 옵션으로 제공된다.
- 이번 장에선 이벤트 스트리밍 플랫폼이 지원하는 부가 기능을 갖춘 분산 메시지 큐를 설계해볼 것이다.

## 1단계: 문제 이해 및 설계 범위 확정

- 기능 요구사항
    - 생산자는 메시지 큐에 메시지를 보낼 수 있다
    - 소비자는 메시지 큐를 통해 메시지를 수신할 수 있다.
    - 메시지는 반복적으로 수신할 수 있어야 하고, 단 한 번만 수신하도록 설정될 수 있어야 한다.
    - 오래된 이력 데이터는 삭제될 수 있다.
    - 메시지 크기는 킬로바이트 수준
    - 메시지가 생산된 순서대로 소비자에게 전달할 수 있어야 한다.
    - 메시지 전달 방식은 최소 한 번, 최대 한 번, 정확히 한 번 가운데 설정할 수 있어야 한다.
- 비기능 요구사항
    - 높은 대역폭과 낮은 전송 지연 가운데 하나 선택 가능
    - 규모 확장성 지원
    - 지속성 및 내구성
        - 데이터를 디스크에 지속적으로 보관
        - 데이터를 여러 노드에 복제

## 2단계: 계략적 설계안 제시 및 동의 구하기

- 메시지 큐는 생산자와 소비자 사이 결합을 느슨하게 하는 서비스
    - 생산자와 소비자의 독립적 운영 및 규모 확장을 가능하게 한다.
    - 클라이언트/서버 모델 관점에서 생산자와 소비자는 모두 클라이언트고 메시지 큐는 서버 역할을 한다.

### 메시지 모델

- 일대일 모델
    - 큐에 전송된 메시지는 오직 한 소비자만 소비
    - 소비자가 많을 순 있지만 오직 한 소비자만 메시지를 가져갈 수 있다.
    - 메시지가 소비되면 큐에 해당 메시지는 삭제된다. (데이터 보관을 지원하지 않음)
- 발행-구독 모델
    - 토픽(topic)
        - 메시지를 주제별로 정리하는 데 사용
        - 각 토픽은 메시지 큐 서비스 전반에 고유한 이름을 가진다.
    - 토픽에 전달된 메시지는 해당 토픽을 구독하는 모든 소비자에게 전달된다.
