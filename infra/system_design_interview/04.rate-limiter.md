# 4장 처리율 제한 장치의 설계
## 처리율 제한이란

- 처리율 제한 장치(rate limiter)
    - 클라이언트 또는 서비스가 보내는 트래픽 처리율을 제어하기 위한 장치
    - API 요청 횟수가 임계치를 넘어서면 추가 요청을 처리가 중단
- 처리율 제한 사례
    - 사용자는 초당 2회 이상 새 글 업로드 불가
    - 같은 IP 주소로는 하루 10개 이상 계정 생성 불가
    - 같은 디바이스로는 주당 5회 이상 리워드 요청 불가
- 처리율 제한 장점
    - Dos(Denial of Service) 공격에 의한 자원 고갈 방지
    - 비용 절감
        - 서버 확장을 많이 하지 않아도 된다.
        - 우선순위가 높은 API에 더 많은 자원 할당 가능
        - 서드 파티 API를 사용하는 경우 유용(특히 과금이 들어갈 때)
    - 서버 과부하 방지

## 처리율 제한 장치 설계 범위

### 요구사항 정리 (예제)

- 클라이언트 측 제한 장치인가 서버 측 제한 장치인가 → 서버
- API 호출을 제한하는 기준은? → 다양한 제어 규칙을 고려하는 유연한 시스템 (IP, 사용자 ID)
- 시스템 규모는? → 대규모 요청을 처리 가능
- 분산 환경인가? → 그렇다.
- 처리율 제한 장치는 독립된 서비스인지 애플리케이션 코드에 포함되는지? → 알아서 판단
- 사용자는 처리율이 제한에 의해 block되면 그 사실을 알아야 하나? → 그렇다.
- 요약
    - 처리율을 초과하는 요청은 정확히 제한
    - 낮은 응답시간
    - 가능한 적은 메모리 사용
    - 하나의 분산형 처리율 제한 장치를 여러 서버나 프로세스에서 공유 가능해야 한다.
    - 요청이 제한되었을 땐 그 사실을 사용자에게 분명히 보여줘야 한다.
    - 높은 결함 감내성을 가져야 한다. (제한 장치의 장애가 전체 시스템에 영향을 주어서는 안 된다.)

## 처리율 제한 장치는 어디에 둘 것인가

- 클라이언트
    - 클라이언트 요청은 쉽게 위변조가 가능
    - 모든 클라이언트 구현 통제가 어렵다.
- 서버

  ![image](https://github.com/ldk980130/TIL/assets/78652144/27976626-5d3d-466e-97b8-7e69bb36c053)

- 미들웨어

  ![image](https://github.com/ldk980130/TIL/assets/78652144/4459f98c-1273-4d36-b1ba-1570025ccb7d)

    - 처리율이 제한되면 429 상태코드 반환
- 보통 서버 또는 미들웨어에 구현한다.

### API 게이트웨이 (gateway)

- 클라우드 마이크로서비스의 경우 처리율 제한 장치는 API 게이트웨이에 구현된다.
- API 게이트웨이는 완전 위탁관리형 서비스로 클라우드 업체가 유지 보수를 담당하는 서비스다.
    - 처리율 제한
    - SSL 종단(termination)
    - 사용자 인증(authentication)
    - IP 허용 목록(whitelist) 관리

### 구현 위치 선정 시 따져봐야 할 것

- 프로그래밍 언어, 캐시 서비스 등 현재 기술 스택 점검
    - 언어가 서버 측 구현을 지원하기 충분할 정도로 효율적인지 확인
- 사업 필요에 맞는 처리율 제한 알고리즘을 찾아야 한다.
    - 서버 측에서 구현 - 알고리즘을 자유롭게 선택 가능
    - 제3 사업자가 제공하는 게이트웨이 - 알고리즘 선택이 제한될 수도 있다.
- 마이크로서비스 기반의 서비스를 구축하고 있어 이미 API 게이트웨이가 있는 경우
    - 처리율 제한 또한 게이트웨이에 포함시켜야 할 수도 있다.
- 처리율 제한 서비스를 직접 만드는 데는 시간이 든다.
    - 인력이 없다면 상용 API 게이트웨이를 쓰는 것이 바람직하다.

## 처리율 제한 알고리즘

- 널리 알려진 인기 알고리즘
    - 토큰 버킷(token bucket)
    - 누출 버킷(leaky bucket)
    - 고정 윈도 카운터(fixed window counter)
    - 이동 윈도 로그(sliding window log)
    - 이동 윈도 카운터(sliding window counter)
