# 5.4 정확히 한 번 전송

- 카프카에선 멱등성 옵션을 통해 중복 없는 전송을 할 수 있지만 이는 정확히 한 번 전송한다는 의미는 아니다.
    - 중복 없는 전송은 정확히 한 번 전송의 일부 기능일 뿐이다.
    - 카프카에서 정확히 한 번 전송은 트랜잭션과 같은 전체적인 프로세스 처리를 의미한다.
- 트랜잭션 API - 카프카에서 전체적인 프로세스를 관리하기 위해 정확히 한 번 처리를 담당하는 별도의 프로세스

## 5.4.1 디자인

- 카프카로 정확히 한 번 방식으로 메시지를 전송하면 메시지들은 원자적으로 처리되어 전송에 성공하거나 실패하게 된다.
- 트랜잭션 코디네이터가 이러한 트랜잭션을 관리한다.
    - 프로듀서가 보내는 메시지를 관리하여 커밋 또는 중단 등을 표시한다.
    - 트랜잭션 로그를 카프카 내부 투픽인 __transaction_state에 저장한다.
        - 이 토픽 또한 브로커 설정을 통해 관리 가능하다.
- 컨트롤 메시지
    - 카프카가 정상적으로 커밋된 메시지인지 싫패한 것인지 식별하기 위한 특별한 타입의 메시지
    - 페이로드에 애플리케이션 데이터(벨류)를 포함하지 않는다.
    - 애플리케이션에 노출되지 않고 오직 브로커와 클라이언트 통신에서만 사용된다.

## 5.4.2 프로듀서 예제 코드

```java
import org.apache.kafka.clients.producer.KafkaProducer;
import org.apache.kafka.clients.producer.ProducerConfig;
import org.apache.kafka.clients.producer.ProducerRecord;
import org.apache.kafka.clients.producer.Producer;
import org.apache.kafka.common.serialization.StringSerializer;
import java.util.Properties;

public class ExactlyOnceProducer {
    public static void main(String[] args) {
        Properties props = new Properties();
        
        // 정확히 한 번 전송을 위한 설정
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
        props.put(ProducerConfig.ACKS_CONFIG, "all");
        props.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, "true");
        props.put(ProducerConfig.TRANSACTIONAL_ID_CONFIG, "my-transactional-id-001");
        props.put(ProducerConfig.MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION, "5"); 
        props.put(ProducerConfig.RETRIES_CONFIG, "5");

        Producer<String, String> producer = new KafkaProducer<>(props);

        producer.initTransactions(); // 프로듀서 트랜잭션 초기화

        try {
            producer.beginTransaction(); // 프로듀서 트랜잭션 시작
            producer.send(new ProducerRecord<>("test-topic", "key1", "value1"));
            producer.send(new ProducerRecord<>("test-topic", "key2", "value2"));
            producer.flush();
            producer.commitTransaction(); // 프로듀서 트랜잭션 커밋
        } catch (Exception e) {
            producer.abortTransaction(); // 프로듀서 트랜잭션 중단
            e.printStackTrace();
        } finally {
            producer.close();
        }
    }
}

```

- 위 예제 코드에서 주의할 점은 `TRANSACTION_ID_CONFIG`를 프로듀서마다 고유하게 설정해야 한다는 것이다.

