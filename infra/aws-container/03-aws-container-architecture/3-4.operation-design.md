# 3-4 운영 설계
- ‘운영 우수성’을 만족시키기 위해선 다음 설계 검토 사항을 확인한다.
    - 어떻게 시스템 상태를 파악할 것인가
    - 어떻게 시스템의 버그 수정을 쉽게 할 것인가
    - 어떻게 배포할 때의 위험을 줄일 것인가
- 이번 장에서는 ECS/Fargate 이용 시 시스템 상태 파악을 위한 다음 설계에 대해 검토해보자
    - 모니터링과 감시에 대한 설계
    - 버그 수정과 배포할 때의 위험을 줄이기 위한 CI/CD 설계

## 모니터링과 옵저버빌리티(Observability)의 중요성

- 모니터링의 주 목적은 시스템에 문제가 발생하는 것을 즉시 발견해 시스템의 가용성을 유지하는 것이다.
    - 메모리 사용율이나 디스크 사용율
    - 애플리케이션 로그를 통한 정성적 정보
    - 상태 이상을 감지해 경보를 발생
- 옵저버빌리티(가관측성)
    - 시스템 전체를 살펴보며 내부 상태까지 깊이 파고들 수 있는 상태를 말한다.
    - 문제 발생 원인을 조사하려면 트랜잭션 흐름과 애플리케이션 내부 자세한 흐름을 파악해야 하는 경우도 있다.
- AWS에는 CloudWatch와 연계해 각종 로그와 지표 정보를 수집할 수 있는 서비스가 있다.
    - ECS/Fargate 구성에선 CloudWatch Logs나 FireLens를 활용할 수 있다.
    - X-Ray와의 조합으로 요청 흐름을 추적 가능

> 모니터링의 목적은 ‘이용자가 애플리케이션을 이용할 수 있는 상태를 유지하기 위한 것’이다. 중요한 점은 로그나 지표에 관계없이 모니터링은 이용자의 경험이 손상되는 이벤트를 염두에 둬야 한다는 점이다.
>

## 로깅 설계

- ECS/Fargate 구성에서 로그 수집 절차는 크게 두 가지 방법이 있다.
    - CloudWatch Logs
    - FireLens

### CloudWatch Logs를 이용한 로그 운영

- 애플리케이션 로그 검색 가능
- ‘구독 필터’를 이용하면 로그 내 특정 문자열이 포함된 경우의 로그만 추출 가능
    - Lambda나 SNS 연계를 통한 장애 알림을 구성할 수도 있다.
- 로그 보존 기간을 설정할 수 있으므로 로그의 유지보수 처리도 자동화할 수 있다.
- 단순한 애플리케이션이나 대량으로 로그가 발생하지 않는 경우라면 CloudWatch Logs만으로 충분하다.

### FireLens를 이용한 로그 운영

- FireLens를 이용하면 AWS 서비스나 그 외의 SaaS에 로그를 쉽게 전송할 수 있다.
- Fluent Bit
    - 로그 라우팅 기능을 담당하는 소프트웨어 (오픈 소스)
    - AWS는 높은 자원 효율로 인해 FireLens와 Fluent Bit의 연계를 추천한다.
    - AWS가 공식적으로 제공하는 전용 컨테이너 이미지 사용 가능
        - ECS 태스크 정의 안에 애플리케이션용 컨테이너와 Fluent Bit 컨테이너를 함께 구성 가능
- FireLens는 아래 SaaS와 연동이 가능하여 데이터 분석 용도로 많이 사용될 수 있다.
    - Redshift - 데이터 웨어하우스용 관리형 데이터베이스
    - OpenSearch Service - 관리형 검색 엔진 서비스
- FireLens는 S3뿐 아니라 CloudWatch Logs에도 동시에 로그를 전송할 수 있다.
    - ECS 태스크 정의 제약과 관련이 있는 장점

### CloudWatch Logs와 FireLens의 선택 기준 및 로그 운영 디자인

- ECS 태스크 정의 사양의 한계
    - 각 컨테이너가 어디에 로그를 출력할지 지정하는 로그 드라이버 정의는 1개뿐이다.
    - 로그를 장기 보존하기 위해 애플리케이션 접속 로그는 S3에, 에러 로그는 CloudWatchLogs에 전송하려면 어떻게 해야할까?
- CloudWatch Logs에 로그를 한 번 전송한 뒤 S3로 내보내는 방법
    - CloudWatch Logs는 로그 취득 시점에 과금이 발생한다.
- CloudWatch Logs의 구독 필터 기능을 이용해 Firehose를 경유해 S3에 로그를 저장하는 방법
    - 결국 CloudWatch에 한 번 로그를 저장하므로 비용이 발생한다는 점은 똑같다.
    - Firehose 또한 요금이 추가된다.
- FireLens를 로그 드라이버로 지정하는 방법
    - 로그 보존 관점의 비용 최적화와 운영을 모두 만족시키는 방법
    - Fluent Bit는 CloudWatch Logs와 S3 양쪽에 동시에 로그를 전송할 수 있다.
    - 이 구성을 위해선 AWS 내부의 태스크 정의가 아닌 Fluent Bit 자체 설정 파일을 수정해 Fluent Bit 컨테이너 안에 넣어야 한다.
- Fluent Bit에서 로그 출력을 나누는 방법
    - 첫 번째는 S3 버킷에 설정 파일을 올려두고 태스크 정의를 할 때 해당 버킷 위치를 지정해서 태스크가 시작될 때 파일을 읽어 들이는 방법
        - 복잡한 로그 라우팅을 설정해야 한다면 S3는 한 개 파일만 가능하므로 여러 파일을 함께 교체할 수 없다.
    - 두 번째는 사용자 정의 설정 파일을 추가한 Fluent Bit 컨테이너 이미지를 직접 만든 뒤 태스크 정의에서 대상 컨테이너로 지정하는 방법
    - S3를 만약 이용한다면 이미지 관리를 비롯해 이미지 버전과 수명 주기 등 관리가 발생한다.
