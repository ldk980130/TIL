# 8장 복제
- 가용성은 일반적으로 서비스 안정성을 측정하는 지표다
    - `Availability = Available for Use Time / Total Time`
- 레디스에서 고가용성을 확보하기 위한 기능
    - 복제: 마스터 노드 데이터를 복제 노드로 실시간 복사하는 기능
    - 자동 페일오버: 마스터 노드의 장애를 감지해 클라이언트 연결을 자동으로 복제 노드로 리다이렉션하는 기능

## 레디스에서의 복제 구조

- 복제본 노드를 추가하는 이유
    - 서비스를 안정적으로 운영하기 위해서
    - 대규모 서비스에서 트래픽을 감소시키는 역할 수행
    - 데이터의 백업을 복제본에서 수행하면 백업 작업이 서비스에 미치는 영향을 최소화할 수 있다.
- 레디스는 멀티 마스터 구조를 지원하지 않아 마스터는 복제본이 될 수 없다.
    - MySQL이나 PostgreSQL은 멀티 마스터 복제 구조를 제공
    - 모든 데이터 입력은 마스터 노드에서, 복제본은 데이터를 그대로 받아온다.

### 복제 구조 구성하기

```bash
REPLICAOF <master-ip> <master-port>
```

- 복제본이 될 노드에서 위 커맨드를 입력해 마스터 노드 정보를 입력하면 복제 연결이 시작된다.
    - 마스터 다운 시 연결 설정을 복제본으로 변경하면 서비스를 지속할 수 있다.
- 레디스 복제 그룹에선 항상 하나의 마스터 노드만 존재한다.
    - 레디스 마스터에는 여러 복제본이 연결될 수 있다.
    - 복제본에 새로운 복제본을 추가할 수도 있다.
    - 복제본은 읽기 전용이다.

### 패스워드 설정

- 기본적인 패스워드를 사용해서 데이터를 복제할 때에는 `masterauth` 옵션에 패스워드를 입력해야 한다.
- 레디스에선 `requirepass` 옵션으로 패스워드를 설정할 수 있다.
    - 복제본은 `masterpass` 옵션에 마스터의 `requirepass`에 설정된 패스워드를 입력해야 한다.
- 하나의 복제 그룹에 속한 마스터와 복제 노드는 같은 패스워드로 하는 것이 일반적이다.

## 복제 메커니즘

- 레디스의 복제 과정은 자동으로 이뤄지며 개발자의 개입이 필요치 않다.
- 버전 7 이전에는 `repl-diskless-sync` 옵션이 기본으로 no이며 아래와 같은 과정으로 복제 연결이 이뤄졌다.
  1. `REPLICAOF` 커맨드로 복제 연결 시도
  2. 마스터 노드에서 fork로 자식 프로세스를 만들고 RDB 스냅숏 생성
  3. (2)번 과정 동안 이뤄지는 모든 데이터 변경은 마스터의 복제 버퍼에 저장됨
  4. RDB 파일이 생성 완료되면 파일은 복제본 노드로 복사
  5. 복제본에 저장됐던 모든 내용을 지우고 RDB 파일으로 데이터를 로딩
  6. 복제 과정 동안 버퍼링됐던 복제 버퍼 데이터를 복제본으로 전달
- 위 과정에서 복제 속도는 디스크 I/O 처리량에 영향 받는다.
  - 마스터에서 RDB 파일을 저장, 복제본에서 RDB 파일을 읽는 과정 모두 디스크 I/O
- 버전 7 이후부터 `repl-diskless-sync` 옵션 기본값이 yes로 변경되었다.
  1. `REPLICAOF` 커맨드로 복제 연결 시도
  2. 마스터 노드는 소켓 통신을 통해 복제본 노드에 연결하고 RDB 파일은 생성됨과 동시에 점진적으로 복제본의 소켓에 전송된다.
  3. (2)의 과정 동안 이뤄지는 모든 데이터 변경은 마스터의 복제 버퍼에 저장된다.
  4. 소켓에서 읽어온 RDB 파일을 복제본 디스크에 저장한다.
  5. 복제본의 모든 데이터를 삭제한 뒤 RDB 파일 내용을 메모리에 로딩
  6. 복제 버퍼의 데이터를 복제본으로 전달해 수행
- 복제본의 `repl-diskless-load` 옵션은 기본으로 `disabled`이다.
  - 소켓에서 읽어온 데이터를 바로 메모리에 로드하지 않고 일단 디스크에 저장
  - 소켓으로 받아온 RDB 데이터가 정상적인지 미리 확인할 수 없기 때문
  - 기존 데이터를 모두 삭제하기 전 디스크에 데이터를 저장함으로 데이터 안정성을 확보 가능
- 만약 디스크 I/O가 느리고 네트워크가 빠른 경우엔 디스크를 사용하지 않는 복제 방식이 더 빠르다.
  - 디스크를 사용하는 복제를 사용한다면 RDB 파일 생성 도중 다른 노드에서 복제 연결 요청이 들어오면 이 연결은 큐에 저장된다.
  - 기존 RDB 파일의 저장이 완료되면 여러 복제본이 한 번에 복제 연결을 시작 가능하다.
  - 하지만 디스크를 사용하지 않는 방식에선 복제가 끝나기 전까지 다른 복제본과의 연결은 수행될 수 없다.
  - 다른 복제본들은 복제 연결이 끝날 때까지 큐에서 대기해야 한다.
  - 큐에서 대기하는 것을 방지하기 위해 `repl-diskless-sync-delay` (기본값 5초)를 사용하면 값만큼 기다린 뒤 복제 연결을 시작하게 된다.
  - 마스터는 여러 복제 연결이 들어오면 동시에 RDB 파일을 전송할 수 있게 되기에 이 옵션을 활성화하는 것이 좋다.
