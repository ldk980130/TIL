# 4장 레디스 자료 구조 활용 사례
## sorted set을 이용한 실시간 리더보드

- 리더보드란 경쟁자들의 순위와 현재 점수를 보여주는 순위표다.
- 리더보드는 사용자 증가에 따라 가공할 데이터가 몇 배로 증가한다.
    - 스코어 기반으로 데이터를 정렬하기 때문
- 또한 실시간으로 반영되어야 하기에 여러 수학적 계산이 빠르게 수행되어야 한다.
- 레디스의 `sorted set`을 사용하면 데이터는 정렬돼 들어간다.

```bash
> ZADD daily-score:220817 28 player:286
(integer) 1

> ZADD daily-score:220817 400 player:234
(integer) 1
```

- `ZRANGE` 커맨드로 스코어가 낮은 순서부터 출력 가능하고 `ZREVRANGE` 커맨드로 잘라서 조회할 수 있다.
    - `ZREVRANGE`은 내림차순

```bash
> ZREVRANGE daily-score:220817 0 2 withscores
1) "player:234"
2) "400"
3) "player:24"
4) "357"
5) ...
```

### 데이터 업데이트

- 데이터를 업데이트 해야 한다면 다음 커맨드로 쉽게 가능하다.
    - 중복으로 저장되지 않기에 스코어만 다르면 신규 입력으로 업데이트 된다.
    - 그에 맞춰 데이터 순서도 다시 정렬된다.

```bash
ZADD daily-score:220817 200 player:286
```

- `ZINCRBY` 커맨드로 입력값만큼 증가시킬 수도 있다.

```bash
# 원래 245였다면 345로 업데이트
ZINCRBY daily-score:220817 100 player:24
```

### 랭킹 합산

- 주간 누적 랭킹은 레디스의 `ZUNIONSTORE` 커맨드로 쉽게 구현할 수 있다.
  - `ZUNIONSTORE` - 지정한 키에 연결된 각 아이템의 스코어를 합산하는 커맨드
- `ZUNIONSTORE`는 `<생성할 키 이름><합산할 키 개수><합산할 키>…`와 같이 사용할 수 있다.
- 아래 예제는 22년 8월 15일부터 17일까지 데이터를 합산한다.

```bash
> ZUNIONSTORE weekly-score:2208-3 3 daily-score:220815 daily-score:220816 daily-score:220817
(integer) 4

# 합산된 데이터 순으로 정렬
> ZREVRANGE weekly-score:2208-3 0 -1 withscores
1) "player:24"
2) "650"
3) ...
```

- `ZUNIONSTORE`로 데이터를 합칠 때 가중치를 줄 수도 있다.
  - 만약 16일에 스코어 2배 이벤트가 있었다면?

```bash
> ZUNIONSTORE weekly-score:2208-3 3 daily-score:220815 
daily-score:220816 daily-score:220817 weights 1 2 1
(integer) 4
```
