# 6장 레디스를 메시지 브로커로 사용하기

- 서비스 간 커넥션 실패는 언제든 발생할 수 있기에 느슨한 결합이 중요할 수 있다.
    - 모듈 간 통신은 비동기 통신을 사용하는 것이 바람직
- 메시지 브로커는 크게 메시징 큐와 이벤트 스트림 두 가지 형태가 존재한다.

## 메시징 큐와 이벤트 스트림

- 메시징 큐
    - 생산자(producer)와 소비자(consumer)
- 이벤트 스트림
    - 발행자(publisher)와 구독자(subscriber)

### 메시징 큐와 이벤트 스트림의 차이

- 방향성
    - 메시징 큐 생산자는 소비자 큐로 데이터를 직접 푸시한다.
    - 스트림 발행자는 특정 저장소에 하나의 메시지를 보내고, 구독자들이 이 메시지를 pull한다.
- 데이터 영속성
    - 메시징 큐는 소비자가 데이터를 읽으면 큐에서 삭제한다.
    - 이벤트 스트림에선 구독자가 읽은 데이터는 바로 삭제되지 않고 저장소 설정에 따라 특정 기간 저장될 수 있다.
- 메시징 큐는 일대일 상황에서, 스트림은 다대다 상황에서 유리하다.

### 레디스를 메시지 브로커로 사용하기

- 레디스의 pub/sub을 사용하면 빠르고 간단하게 메시지를 전달할 수 있다.
    - 발행자가 특정 채널에 데이터를 전송하면 모든 채널 전체에 전파된 뒤 삭제되는 일회성을 가진다.
    - 메시지 전달 보장은 하지 않는다.
    - fire-and-forget 패턴에서 간단한 알림에선 유용하다.

> fire-and-forget - 비동기 프로그래밍에서 사용되는 디자인 패턴. 작업 실행 후 그 결과에 대한 처리가 필요하지 않은 경우 유용하다. 신뢰성이 필요한 경우엔 사용하지 않아야 한다. ex) 로깅, 이벤트 발행, 통계 데이터 수집 등.
>

- 레디스의 list 자료 구조는 메시징 큐로 알맞다.
    - list의 데이터는 push와 pop이 가능
    - list에 새 데이터가 들어오면 대기하다 읽어갈 수 있는 블로킹 기능 제공
- 레디스의 stream을 사용하면 레디스를 완벽한 스트림 플랫폼으로 사용할 수 있다.
    - 데이터를 계속 추가하는 방식 (append-only)
    - 소비자와 소비자 그룹을 통해 데이터 분산 처리를 구현할 수 있다.
    - stream의 메시지를 실시간 리스닝 가능
    - 메시지를 시간대별로 검색 가능

## 레디스의 pub/sub

- 레디스는 아주 가벼운 pub/sub을 제공한다.
  - 모든 레디스 클라이언트는 발행자와 구독자가 될 수 있다.
- 레디서 pub/sub은 최소한의 전달 기능만 제공한다.
  - 신뢰성은 보장할 수 없다.
- 한 번 전파된 데이터는 레디스에 저장되지 않는다.
  - 특정 구독자에게 장애로 메시지가 전달되지 못해도 그 사실을 알 수 없다.

### 메시지 publish하기

```bash
> PUBLISH hello world
(integer) 1
```

- `PUBLISH` 커맨드는 hello라는 채널을 수신하는 모든 구독자에 world라는 메시지를 전파한다.
- 전파 후엔 구독자 수가 반환된다.

### 메시지 구독하기

```bash
> SUBSCRIBE event1 event2
Reading messages...
1) "subscribe"
2) "event1"
3) (integer) 1
1) "subscribe"
2) "event2"
3) (integer) 2
```

- `SUBSCRIBE` 커맨드로 event1과 event2 채널을 동시에 구독하기 시작한다.
- 클라이언트가 구독자로 동작할 때는 pub/sub과 관련되지 않은 커맨드는 사용할 수 없다.
- `PSUBSCRIBE` 커맨드로 특정 패턴에 해당하는 모든 채널을 한 번에 구독할 수 있다.
  - `PSUBSCRIBE mail-*`
  - `mail-`로 시작하는 모든 채널에 전파된 메시지 모두 수신 가능
  - `message`가 아닌 `pmessage` 타입으로 전달됨
  - `SUBSCRIBE`로 구독하는 방식과 구분되기에 같이 사용하면 2개의 메시지를 받게 된다.

### 클러스터 구조에서의 pub/sub

- 레디스 클러스터에서 pub/sub을 사용하면 해당 메시지는 클러스터의 모든 노드에 전달된다.
  - 클러스터의 아무 노드에 연결해 구독하면 데이터를 수신할 수 있다.
  - 하나의 노드에 메시지를 발행하면 메시지는 모든 노드에 전파된다.
- 하지만 대규모 서비스에서 클러스터 모든 노드에 데이터를 복제하는 것은 비효율적이다.
  - 불필요한 리소스 사용, 네트워크 부하 발생

### sharded pub/sub

- 레디스 클러스터의 pub/sub 비효율을 해결하기 위해 레디스 7.0에서 sharded pub/sub이 도입되었다.
- sharded 환경에서 각 채널은 슬롯에 매핑된다.
- 같은 슬롯을 가진 노드 간에만 pub/sub 메시지를 전파한다.
- 모든 노드에 메시지를 전파하지 않아 불필요한 복제를 줄여 자원을 절약할 수 있다.
