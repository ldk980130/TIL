# 7장 레디스 데이터 백업 방법
## 레디스에서 데이터를 영구 저장하기

- 레디스의 데이터는 메모리에서 관리되기에 서비스 장애로 데이터가 손실될 수 있다.
- 레디스를 캐시가 아닌 영구 저장소와 같은 용도로 사용한다면 주기적인 백업이 필요하다.
    - 레디스는 RDB와 AOF 두 가지 백업 방식을 지원한다.
- AOF(Append Only File) - 레디스 인스턴스가 처리한 모든 쓰기 작업을 차례대로 기록, 복원 시에는 파일을 다시 읽어가며 데이터 세트 재구성
    - AOF 파일은 레디스 프로토콜 형태로 저장
    - 모든 쓰기 작업이 기록되기에 데이터가 변경된 내역도 모두 기록된다.
    - 파일 크기가 RDB보다 크고 주기적으로 압축해 재작성해야 한다.
    - 원하는 시점으로 복구할 수 있다.
- RDB (Redis DataBase) - 일정 시점에 메모리에 저장된 데이터 전체를 저장 (snapshot 방식)
    - RDB 파일은 바이너리 형태로 저장
    - 저장되는 시점의 메모리가 그대로 저장되기에 마지막 결과값만 저장된다.
    - 시점 단위로 백업본을 저장 가능하며 AOF 파일보다 복원이 빠르다.
    - 단 특정 시점으로의 복구는 불가능
- 한 인스턴스에서 RDB와 AOF 옵션을 동시에 사용할 수도 있다.
    - 일반적 RDB만큼의 안정성을 원한다면 둘 다 사용하기를 권장
    - 두 개 다 있다면 레디스는 AOF 데이터를 로드한다.

## RDB 방식의 데이터 백업

- RDB 파일은 원하는 시점에 메모리 자체를 스냅숏 찍듯 저장한다.
- 하지만 장애가 발생하면 저장 시점 ~ 장애 발생 시간 사이의 데이터는 손실될 수 있다.
- RDB 파일 생성 방법은 크게 세 가지다.
  - 특정 조건에 자동 RDB 파일 생성
  - 사용자 지정 시점에 커맨드를 이용해 수동으로 RDB 파일 생성
  - 복제 기능으로 자동 RDB 파일 생성

### 특정 조건에 자동으로 RDB 파일 생성

- `save` 옵션을 사용해 원하는 조건에 RDB 파일을 저장하도록 설정 가능하다.
  - redis.conf에서 설정 가능

```bash
save <기간(초)> <기간 내 변경된 키의 개수> dbfilename <RDB 파일 이름> dir <RDB 파일 저장 경로>

# 900초 간 1개 이상 키가 변경된 경우
save 900 1

# 300초 동안 10개 이상의 키가 변경된 경우
save 300 10
```

- `save “”` 옵션으로 RDB 파일을 비활성화할 수 있다.
  - `CONFIG SET save “”`

> CONFIG REWRITE - 레디스 인스턴스 실행 중에 설정 파일을 변경할 수는 없다. 실행 중에 설정을 변경하려면 redis-cli에서 `CONFIG SET` 커맨드로 설정을 변경한 뒤 `CONFIG REWRITE` 커맨드로 설정 파일을 재작성해야 한다. 재작성하지 않으면 인스턴스가 재작성 되어도 변경 전 옵션으로 설정된다.
>
