# 4.4 MySQL 로그 파일

로그 파일을 이용하면 MySQL의 상태나 부하를 일으키는 원인을 쉽게 찾아 해결할 수 있다.

## 4.4.1 에러 로그 파일

MySQL이 실행되는 도중에 발생하는 에러나 경고 메시지가 출력되는 로그 파일이다. MySQL 설정 파일(`my.cnf`)에서 `log_error`라는 이름의 파라미터로 정의된 경로에 생성된다.

- **MySQL이 시작하는 과정과 관련된 정보성 및 에러 메시지**
    - 설정 파일을 변경하거나 서버 비정상 정료 이후 다시 시작하는 경우 에러 로그 파일을 통해 제대로 적용 됐는지 확인해야 한다.
    - MySQL 가동 시 새로 변경하거나 추가한 파라미터에 대한 에러나 경고성 메시지가 없다면 정상 적용된 것이라 판단하면 된다.
    - 변수명을 인식 못하거나 설정된 파라미터 내용을 인식 못하면 MySQL서버가 에러를 출력하고 시작하지 못했다는 메시지를 보여줄 것이다.
- **마지막으로 종료할 때 비정상적으로 종료된 경우 나타나는 InnoDB의 트랜잭션 복구 메시지**
    - InnoDB는 서버 비정상 종료 이후 다시 시작할 때 완료하지 ㅁ소한 트랜잭션을 정리하고 디스크에 기록하는 복구 작업을 하게 된다.
    - 간혹 복구하지 못하는 경우 에러를 출력하고 다시 종료될 것이다.
- **쿼리 처리 도중에 발생하는 문제에 대한 에러 메시지**
    - 쿼리 도중 발생하는 문제는 사전 예방이 어렵다.
    - 때문에 주기적으로 에로 로그 파일을 검토하는 것이 숨겨진 문제를 해결하는 데 많은 도움이 된다.
- **비정상적으로 종료된 커넥션 메시지 (Aborted connection)**
    - 클라이언트 애플리케이션에서 정상적으로 접속을 종료하지 못하고 종료된 경우 남는 메시지
- **InnoDB의 모니터링 또는 상태 조회 명령(**`SHOW ENGINE INNODB STATUS` **같은)의 결과 메시지**
    - InnoDB의 테이블 모니터링이나 락 모니터링, 엔진 상태 조회 명령은 큰 메시지를 에러 로그 파일에 기록한다.
    - InnoDB 모니터링을 활성화하고 유지하면 파일 시스템 공간이 부족해질 수도 있기에 사용 후에는 다시 비활성화해야 한다.
- **MySQL의 종료 메시지**
    - MySQL이 갑자기 종료돼 있거나 재시작되는 경우에 에러 로그 파일에서 종료되면서 출력한 메시지를 확인할 수 있다.

## 4.4.2 제너럴 쿼리 로그 파일(제너럴 로그 파일)

- 실행되는 쿼리 전체 목록을 뽑고 싶을 때 쿼리 로그를 활성화하면 된다.
- 쿼리 로그 파일에는 시간 단위로 쿼리의 내용이 모두 기록된다.
- 제너럴 쿼리 로그는 쿼리 요청을 받으면 바로 기록하기에 에러가 발생해도 기록된다.
- 로그 파일의 경로는 `general_log_file`이라는 이름의 파라미터에 설정되어 있다.

## 4.4.3 슬로우 쿼리 로그

서비스 운영 중에 MySQL 전체적인 튜닝을 한다고 할 때 슬로우 쿼리 로그가 많은 도움이 된다.

- 슬로우 쿼리 로그 파일은 `long_query_time` 시스템 변수에 설정한 시간 이상의 시간이 소요된 쿼리가 모두 기록된다.
    - 쿼리가 정상적으로 실행이 완료 되어야 기록될 수 있다.
- `log_output` 옵션을 통해 파일로 기록할지 테이블로 기록할지 선택 가능
    - `TABLE`, `FILE`

### 슬로우 쿼리 살펴보기

InnoDB에선 MySQL 엔진 레벨 잠금과 스토리지 엔진 레벨 잠금이 각각 있기에 슬로우 쿼리 로그가 혼란스러울 수도 있다.

```sql
# Time: 2020-07-19T15:44:22.178484+09:00
# User@Host: root[root] @localhost [I Id: 14
# Query_time: 1.180245 Lock_time: 0.002658 Rows_sent: 1 Rows_examined: 2844047 
use employees;
SET timestamp=1595141060;
select empno, max(salary) from salaries; 
```

- `Time` 항목은 쿼리가 종료된 시점이다.
    - 시작 시간을 알려면 `Time` 값에서 `Query_time`만큼 빼야 한다.
- `User@Host`는 쿼리를 실행한 사용자의 계정이다.
- `Query_time`은 쿼리가 실행되는 전체 시간을 의미한다.
- `Lock_time`은 MySQL 엔진 레벨에서 관장하는 테이블 잠금에 대한 대기 시간이다.
    - 0이 아니라고 무조건 잠금 대기가 있다고 판단하기는 어렵다.
    - 잠금 체크와 같은 코드 실행 부분의 시간까지 모두 포함되기 때문
    - 즉 매우 작은 값이면 무시해도 무방하다.
- `Rows_examined`는 쿼리가 처리되기 위해 몇 건의 레코드에 접근했느지를 의미한다.
- `Rows_sent`는 처리 결과로서 몇 건의 레코드가 클라이언트로 보내졌는지를 의미한다.
    - `Rows_examined`가 높지만 `Rows_sent`는 상당히 낮다면 더 적은 레코드만 접근하도록 튜닝해볼 수도 있을 것이다. (`GROUP BY`나 집계 함수가 아닌 쿼리인 경우에만 해당)

> 가끔 InnoDB 테이블에 대한 SELECT 쿼리에서 `Lock_time`이 1초 이상 소요될 수 있는데 이는 MySQL 엔진 레벨에서 설정한 테이블 잠금 때문일 가능성이 높다. 그래서 `Lock_time` 값은 튜닝이나 쿼리 분석에 별로 도움 되지 않는다.
>

### Percona Toolkit의 pt-query-digest 스크립트

일반적으로 슬로우 쿼리나 제너럴 로그 파일 내용은 하나씩 검토하기에 너무 복잡하다. Percona Tookit의 pt-querydigest 스크립트를 이용하면 쉽게 빈도나 처리 성능별로 쿼리를 정렬해서 살펴볼 수 있다.

```bash
## General Log 파일 분석
linux> pt-query-digest --type-'genlog' general.log > parsed_general.log
```

```bash
## SLOw Log 파일 분석
linux> pt-query-digest--type='slowlog' mysal-slow.1og > parsed_mysal-slog.log
```

파일 분석이 완료되면 3개의 그룹으로 나뉘어 저장된다.

- 슬로우 쿼리 통계
    - 쿼리 로그 실행 시간과 잠금 대기 시간 등에 대해 평균, 최소/최대 표시
- 실행 빈도 및 누적 실행 시간순 랭킹
    - 각 쿼리 별 응답 시간과 실행 횟수를 보여줌
    - 실행된 쿼리 문장을 정규화해서 만든 Query ID라는 해시 값을 부여
- 쿼리별 실행 횟수 및 누적 실행 시간 상세 정보
    - Query ID마다 쿼리 응답 시간에 대한 히스토그램 같은 상세 내용을 보여준다.