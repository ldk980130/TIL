## 4.2.11 리두 로그 및 로그 버퍼

### 리두 로그

- **리두 로그**는 ACID 중 D(Durable)와 밀접하며 MySQL 서버가 비정상적으로 종료됐을 때 데이터 파일에 기록되지 못한 데이터를 잃지 않게 해주는 안전장치다.
- 데이터 파일 쓰기는 디스크의 랜덤 액세스가 필요해 비용이 크다. 때문에 DB 서버는 쓰기 비용이 낮은 자료 구조를 가진 리두 로그를 가진다.
- 데이터베이스는 ACID도 중요하지만 성능도 중요하기에 데이터 파일과 리두 로그를 버퍼링할 수 있는 InnoDB 버퍼 풀이나 로그 버퍼 같은 자료 구조를 가진다.

### 일관되지 않은 데이터

MySQL 서버가 비정상 종료되는 경우 다음의 두 가지 일관되지 않은 데이터를 가질 수 있다.

1. 커밋됐지만 데이터 파일에 기록되지 않은 데이터
    1. 리두 로그에 저장된 데이터를 데이터 파일에 다시 복사하기만 하면 된다.
2. 롤백됐지만 데이터 파일에 이미 기록된 데이터
    1. 리두 로그로는 해결할 수 없고 언두 로그의 내용을 가져와 데이터 파일에 복사하면 된다.
    2. 변경이 커밋됐는지, 롤백됐는지, 트랜잭션 실행 중간 상태였는지를 확인하기 위해 리두 로그가 필요하긴 하다.

### 리두 로그의 디스크 동기화 주기

- 리두 로그는 트랜잭션이 커밋되면 즉시 디스크로 기록되도록하는 것을 권장한다.
    - 그래야 서버 비정상 종료 시 트랜잭션 커밋 내용이 리두 로그에 기록될 수 있고, 그 로그로 복구가 가능해진다.
    - 하지만 커밋마다 디스크에 기록하는 것은 부하를 유발한다.
- `innodb_flush_logg_at_trx_commit` 시스템 변수로 리두 로그의 디스크 동기화 주기를 설정할 수 있다.
    - `=0` : 1초에 한 번씩 리두 로그를 디스크에 기록하고 동기화를 실행한다. 그래서 MySQL 서버 비정상 종료 시 1초 간의 데이터는 사라질 수 있다.
    - `=1` : 커밋마다 디스크로 기록되고 동기화까지 수행된다.
    - `=2` :  커밋마다 로그를 디스크로 기록하지만 실질적인 동기화는 1초에 한 번씩 실행된다. MySQL 서버가 비정상 종료되어도 데이터는 사라지지 않으나 운영체제까지 비정상 종료되면 1초간의 데이터는 사라질 수 있다.
    - 0이나 2인 경우에도 스키마 변경의 DDL이 실행되면 리두 로그가 디스크로 동기화되기에 1초보다 빠를 수도 있다.
    - `innodb_flush_log_at_timeout` 변수로 동기화 주기를 1초 말고 다른 값으로 바꿀 수도 있지만 바꿀 이유가 특별히 없다.

### 리두 로그 파일

- 리두 로그 파일들의 전체 크기는 InnoDB 버퍼 풀 효율성을 결정하기에 신중히 정해야 한다.
    - 적절히 정해져야 변경 내용을 버퍼 풀에 모았다가 한 번에 모아 디스크에 기록할 수 있다.
- `innodb_log_file` 변수로 리두 로그 파일의 크기를, `innodb_log_files_in_group` 변수로 리두 로그 파일 개수를 결정하기에 전체 리두 로그 파일 크기는 두 변수의 곱이다.
- 변경이 너무 많은 DBMS 서버의 경우 리두 로그 작업이 큰 문제가 되는데 ACID를 보장하는 수준에서 로그 버퍼를 통해 버퍼링한다.
    - 로그 버퍼 크기는 기본값 16MB가 적합한데 BLOB이나 TEXT 같은 큰 데이터의 변경이 잦다면 더 크게 설정하는 것도 좋다.

### 리두 로그 아카이빙

- MySQL 8.0부터 InnoDB 스토리지 엔진의 리두 로그를 아카이빙할 수 있게 됐다.
    - 데이터 파일을 복사하는 동안 리두 로그에 쌓인 내용을 계속 추적하며 새로 추가된 리두 로그 엔트리를 복사한다.
    - 데이터 변경이 너무 많아 리두 로그가 빠르게 증가하면 리두 로그 내용을 복사하기도 전에 덮어쓰일 수도 있다. → 백업이 실패하게 됨
    - 리두 로그 아카이빙 기능은 리두 로그가 덮어쓰여도 백업이 실패하지 않게 해준다.

### 리두 로그 활성화 및 비활성화

- MySQL 8.0 이후부터는 수동으로 리두 로그를 활성화하거나 비활성화할 수 있게 됐다.
    - 트랜잭션이 커밋되어도 데이터 파일은 즉시 디스크로 동기화되지 않지만 리두 로그는 항상 디스크로 기록된다. (또는 설정에 따라 1초 간격)
    - 데이터를 복구하거나 대용량 데이터를 한 번에 적재하는 경우 리두 로그를 비활성화해 적재 시간을 단축시킬 수 있게 된다.
    - `ALTER INSTANCE DISABLE INNODB REDO_LOG; //비활성화`
    - `ALTER INSTANCE ENABLE INNODB REDO_LOG; // 활성화`
- 어떤 목적에 의해 리두 로그를 비활성화 했다면 작업이 끝나면 반드시 활성화시켜야 한다. 그래야 장애 발생 시 리두 로그로 복구가 가능하다.
