# 09장 일관성과 합의
- 분산 시스템에서의 문제를 해결하는 방법
    - 전체 서비스가 실패하도록 두고 오류 메시지를 보여주기
    - 위 해결이 싫다면 결함을 견뎌낼(tolerating) 수 있도록 내결함성 구축하기

> 살아 있지만 틀린 게 나은가, 올바르지만 죽은 게 나은가?
>

- 내결함성이 지닌 분산 시스템이 극복해야 하는 것
    - 네트워크 상의 패킷 손실
    - 패킷 순서의 변경 및 중복
    - 네트워크 지연
    - 노드 장애
- 내결함성을 지닌 시스템을 구축하려면 유용한 보장을 해주는 범용 추상화를 찾고 애플리케이션에서 이 보장에 의존하게 해야 한다.
    - ex) 트랜잭션 추상화를 통해 충돌, 경쟁 조건, 디스크 장애로부터 애플리케이션이 신경쓰지 않게 해줌
    - 분산 시스템에서 중요한 추상화 중 하나는 바로 ‘합의’다.

## 일관성 보장

- 복제 데이터베이스는 대부분 최소한 최종적 일관성을 제공한다.
    - DB에 쓰기를 멈추고 불특정 시간 동안 기다린다면 결국 모든 읽기 요청이 같은 값을 반환한다는 뜻
    - 매우 약한 보장이기도 한데 언제 복제본에 값들이 수렴될지에 대해선 불확실하다.
    - 최종적 일관성의 에지 케이스는 시스템에 결함이 있거나 동시성이 높을 때만 분명히 드러난다.
- 이에 반해 강한 일관성 모델도 존재하는데 그 중 하나가 바로 선형성(linearizability)이다.

## 선형성

- 선형성
    - 정확한 정의는 매우 미묘하다.
    - 기본 아이디어는 시스템에 데이터 복사본이 하나만 있고 모든 연산은 원자적인 것처럼 보이게 만드는 것
- 선형성 시스템에선 클라이언트가 쓰기를 완료하면 데이터베이스를 읽는 모든 클라이언트는 그 값을 바로 볼 수 있어야 한다.
    - 선형성은 다시 말해 최신성 보장(recency guarangee)다.
    - 데이터 복사본이 하나만 있다는 환상을 유지하는 것은 뒤쳐진 캐시나 복제본에서 나온 값이 아니라고 보장해준다는 뜻

### 시스템에 선형성을 부여하는 것은 무엇인가?

- 여러 클라이언트가 동시에 같은 키를 읽고 쓴다고 가정했을 때 쓰기 연산과 시간이 겹치는 읽기 연산은 이전 값을 반환할 수도, 새로운 값을 반환할 수 도 있다.
    - 읽기 연산이 처리되는 시점에 쓰기의 영향을 받았는지 알 수 없기 때문
    - 하지만 이러한 현상은 ‘데이터의 단일 복사본’을 모방하는 시스템에 기대하는 바는 아니다.
- 시스템이 선형적이려면 한 클라이언트의 읽기가 새로운 값을 반환하면 이후의 모든 읽기 또한 새로운 값을 반환해야 한다.
    - 심지어 쓰기 연산이 아직 완료되지 않았더라도 말이다.
- 선형성을 만족하려면 모든 연산들이 항상 시간순으로 진행되어야 하고 결코 뒤로 가서는 안 된다.
