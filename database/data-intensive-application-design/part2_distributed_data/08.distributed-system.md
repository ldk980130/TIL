# 08장 분산 시스템의 골칫거리
## 결함과 부분 장애

- 부분 장애(partial failure)
    - 분산 시스템에선 어떤 부분은 잘 동작하지만 다른 부분은 예측할 수 없이 고장날 수도 있다.
    - 부분 장애는 비결정적이다.
    - 네트워크와 관련되어 어떨 때는 동작하지만 어떨 때는 실패한다.

### 클라우드 컴퓨팅과 슈퍼컴퓨팅

- 대규모 컴퓨팅 시스템 구축 방법 종류
    - 고성능 컴퓨팅 분야 - 슈퍼컴퓨터 등으로 계산 비용이 매우 높은 과학 계산 작업에 사용된다.
    - 클라우드 컴퓨팅 - 데이터센터, IP 네트워크로 연결된 상용 컴퓨터 등과 관련돼 있다.
    - 고성능 컴퓨팅과 클라우드 컴퓨팅의 중간 지점인 전통적인 기업형 데이터 센터
- 이 책에선 인터넷 서비스를 구현하는 시스템을 집중적으로 다루며 다음과 같은 특징이 있다.
    - 언제라도 사용자에게 지연이 낮은 서비스를 제공해야 한다.
    - 부분 장애 가능성을 받아들이고 소프트웨어에 내결함성 메커니즘이 필요하다.
    - 지리적으로 분산된 배포를 하기에 통신 대부분이 인터넷을 거친다.
- 분산 시스템에선 의심, 비관주의, 편집증을 가지는 것이 좋다.
    - 발생 가능성이 낮은 결함이더라도 광범위하게 고려하고 테스트할 필요가 있다.

## 신뢰성 없는 네트워크

- 전통적 인터넷 서비스를 위한 분산 시스템은 비공유 시스템이다.
    - 즉 네트워크로 연결된 다수의 장비
    - 상대적으로 저렴하고 지리적으로 분산되어 높은 신뢰성 확보가 가능
- 인터넷과 데이터센터 내부 네트워크 대부분은 비동기 패킷 네트워크이기에 여러 가지가 잘못될 수 있다.
    - 요청이 손실 됐을 수도 있다.
    - 요청이 큐에서 대기하다 나중에 전송될 수 있다.
    - 원격 노드에 장애가 생겼을 수 있다.
    - 원격 노드가 일시적으로 응답하기를 멈췄지만 나중에 다시 응답할 수 있다.
    - 원격 노드가 요청을 처리했지만 응답이 네트워크에서 손실됐을 수 있다.
    - 원격 노드가 요청을 처리했지만 응답이 지연되다 나중에 전송될 수 있다.

### 현실의 네트워크 결함

- 100% 신뢰성 있는 네트워크를 만드는 방법은 아직 없는 듯 하다.
    - EC2 같은 공개 클라우드 서비스는 일시적 네트워크 결함이 자주 발생한다.
    - 비공개 데이터센터는 더 안정적일 순 있지만 네트워크 토폴로지 재구성을 유발하고 패킷이 1분 이상 지연될 수도 있다.
    - 상어가 해저 케이블을 물어뜯어 손상시키기도 한다.
- 네트워크 결함이 드물더라도 일어날 수 있기에 소프트웨어는 이를 처리할 수 있어야 한다.
    - 네트워크 결함을 견디도록 처리하기 보다 사용자에게 오류를 보여주는 것도 타당한 방법이다.
    - 소프트웨어가 네트워크 문제에 반응하여 복구될 수 있도록 보장하는 것이 중요하다.

### 결함 감지

- 많은 시스템은 결함 있는 노드를 자동으로 감지할 수 있어야 한다.
- 하지만 네트워크의 불확실성 때문에 노드가 동작 중인지 구별이 어렵다.

### 타임아웃과 기약 없는 지연

- 타임아웃은 결함을 감지하는 수단이지만 얼마나 기다려야 하는지 간단하지 않다.
  - 타임아웃이 길면 노드가 죽었다고 판단하기까지 대기 시간이 길어진다.
  - 타임아웃이 짧으면 노드가 일시적으로 느려졌을 뿐일 때도 죽었다고 선언할 위험이 높아진다.
- 시스템이 이미 높은 부하에 있다면 성급한 노드 결함 선언은 문제를 악화시킬 수 있다.
  - 연쇄적인 장애 유발

### 네트워크 혼잡과 큐 대기

- 컴퓨터 네트워크에서 패킷 지연의 변동성은 큐 대기 때문인 경우가 많다.
  - 여러 노드가 같은 목적지로 패킷을 보내려 하면 네트워크 스위치는 패킷을 큐에 넣고 한 번에 하나씩 목적지 네트워크 링크로 넘겨야 한다. (네트워크 혼잡)
  - 패킷이 목적지에 도착해도 모든 CPU 코어가 바쁜 상태라면 준비가 될 때까지 OS가 큐에 넣어 둔다.
  - TCP는 흐름 제어를 수행하면서 자신의 송신률을 제한하기에 데이터는 네트워크에 들어가기 전에도 부가적인 큐 대기를 할 수도 있다.
  - TCP는 타임아웃 안에 확인 응답을 받지 않으면 패킷 손실로 간주하고 손실 패킷을 자동으로 재전송하는데 이로 인한 지연도 존재한다.
- 큐 대기 지연은 시스템의 최대 용량까지 광범위하게 일어난다.
- 좋은 방법은 고정된 타임아웃을 설정하는 대신 지속적으로 응답 시간과 변동성을 측정해 타임아웃을 동적으로 조절하는 것이다.
  - 아카(Akka)와 카산드라 그리고 TCP 재전송 타임아웃도 비슷한 방법을 사용한다.

### 동기 네트워크 대 비동기 네트워크

- 동기식 네트워크
  - 요청과 응답이 직렬적으로 이루어져 한 작업이 완료될 때까지 다음 작업이 진행되지 않는다.
  - 데이터가 여러 라우터를 거치더라도 큐 대기 문제를 거치지 않는다.
  - 큐 대기가 없기에 네트워크 종단 지연의 최대치가 고정돼 있다.
  - ex) 전화 통화 - 전화 회선은 다른 누구도 사용할 수 없는 고정된 대역폭을 사용하며 초당 비트 개수가 상당히 고정돼 있다.
- 비동기 네트워크
  - 요청과 응답이 병렬적으로 이루어지며 요청을 보낸 후 응답을 기다리지 않고 다른 작업을 수행한다.
  - TCP 연결의 경우 네트워크 대역폭을 기회주의적으로 사용해 가변 크기의 데이터 블록을 짧은 시간 안에 전송하려 한다.
  - ex) 웹 페이지 요청, 이메일 전송 등 - 순간적으로 몰리는 트래픽에 최적화됨
- 회선(동기식 네트워크)을 통해 파일 등을 전송하는 작업은 대역폭 할당을 추정해야 하기에 어렵다.
  - 추정치가 너무 낮으면 네트워크 용량을 쓰지 않고 남겨 둔 상태로 전송이 불필요하게 느려진다.
  - 추정치가 너무 높으면 회선은 구성될 수 없다.
    - 회선 교환은 대역폭 할당을 보장할 수 없다면 회선 생성을 허용하지 않기 때문
  - 반대로 TCP는 네트워크 용량에 맞춰 데이터 전송률을 동적으로 조절한다.
- 이러한 이유로 현대 웹 서비스들은 비동기 네트워크를 사용할 수밖에 없고, 네트워크 변동성으로 인한 기약 없는 지연이 발생할 것이라고 가정해야 한다.
