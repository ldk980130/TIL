# 05장 복제
- 복제가 필요한 이유
    - 지리적으로 사용자와 가깝게 데이터를 유지해 지연 시간을 줄인다.
    - 시스템 일부에 장애가 발생해도 지속적으로 동작할 수 있게 가용성을 높인다.
    - 읽기 질의를 제공하는 장비 수를 확장해 읽기 처리량을 늘린다.
- 복제에서 모든 어려움은 복제된 데이터의 변경 처리에 있다.
- 노드 간 변경 복제를 위한 세 가지 인기 알고리즘이 있다.
    - 단일 리더 (single-leader)
    - 다중 리더 (multi-leader)
    - 리더 없는 (leaderless)

## 리더와 팔로워

- 복제 서버(replica) : 데이터베이스 복사본을 저장하는 각 노드
- 리더 기반 복제(leader-based replication)
    - 또는 능동/수동, 마스터 슬레이브 복제라고도 한다.
    - 복제 서버 중 하나를 리더(마스터 or 프라이머리)로 지정 후 리더가 먼저 데이터를 기록하게 된다.
    - 다른 복제 서버(팔로워 or 슬레피브)는 리더의 데이터 변경을 복제 로그나 변경 스트림 일부로 전달 받아 복사본을 갱신한다.
    - 쓰기는 리더에게만 허용되고 질의는 팔로워에게 가능하다.
- 이러한 복제 모드는 다양한 데이터베이스에 내장된 기능으로 제공한다.

### 동기식 대 비동기식 복제

- 동기식 복제
    - 리더는 팔로워가 쓰기를 수신했는지 확인할 때까지 대기한다.
    - 메시지 처리 전까지 상당한 지연이 발생할 수 있다.
    - 장점은 리더와 팔로워가 일관성 있게 최신 데이터 복사본을 가지는 것을 보장한다.
    - 단점은 팔로워가 응답하지 않는다면 쓰기가 처리될 수 없다.
- 비동기식 복제
    - 리더는 팔로워가 수신했는지 기다리지 않는다.
    - 리더에만 쓰기를 성공하면 되기에 지연이 낮다.
    - 팔로워가 응답하지 않더라도 서비스를 지속할 수 있다.
- 보통 리더 기반 복제는 완전 비동기식으로 구성한다.
    - 팔로워에 쓰기가 유실될 수 있어 지속성을 보장하지는 못한다.
    - 그럼에도 비동기식 복제는 많이 사용되는 방식이다.

### 새로운 팔로워 설정

- 새로운 팔로워를 설정해야할 때가 있다.
    - 복제 서버 수 증설
    - 장애 노드의 대체
- 새로운 팔로워 설정 시 리더의 데이터를 복사하는 방식
    - 전체 데이터베이스를 가능한 잠그지 않고 스냅숏을 가져온다.
    - 스냅숏을 새로운 팔로워 노드에 복사한다.
    - 팔로워는 리더에 연결해 스냅숏 이후의 데이터 변경을 요청한다.
    - 팔로워가 스냅숏 이후 변경의 미처리분을 모두 처리했을 때 따라잡았다고 말하고 이제부터 리더에 발생하는 데이터 변화를 이어 처리 가능하다.
