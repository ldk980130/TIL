# Chapter 15 자바 9와 미래

- 자바 9에서 모듈이 도입
- 모듈이 성능에 큰 비중을 차지하는 건 아니기에 모듈에 집중하지는 않는다.

## 15.1 자바 9에서 소소하게 개선된 성능

- 코드 캐시 세그먼트화
- 콤팩트 스트링
- 새로운 스트링 연결
- C2 컴파일러 개선
- G1 새 버전

### 15.1.1 코드 캐시 세그먼트화

- 자바 9부터 코드 캐시 성능을 개선하고자 다음 항목별로 영역을 분리
    - 인터프리터 등의 논메서드 코드
    - 프로파일드 코드
    - 논프로파일드 코드
- 스위퍼 가동 시간이 짧아지고 풀 최적화 코드에 대한 코드 지역성이 향상된다.
- 다른 영역은 공간이 남는데 특정 영역이 꽉 찰 수 있다는 단점은 존재
- https://openjdk.org/jeps/197

### 15.1.2 콤팩트 스트링

- 자바에서 스트링은 항상 `char[]`타입으로 저장된다.
    - `char`는 2바이트(16비트)
    - 통계적으로 Latin-1 스트링 데이터가 많이 쓰이는데 1바이트만 필요
    - ASCII 스트링을 저장하면 남는 바이트 공간엔 0이 채워지며 실제로 필요한 공간의 2배 정도를 더 차지한다.
- 자바 9 이후 콤팩트 스트링 덕에 스트링 단위로 최적화가 가능해졌다.
    - Latin-1 캐릭터로 표기 가능한 스트링은 `byte` 배열로 나타낼 수 있다.
    - 기존 `char` 배열로 나타닐 때 0으로 채워졌던 바이트 개수만큼 절약 가능
- 자바 9부터 `String` 클래스의 소스 코드에 `value` 필드 타입이 `char[]`에서 `byte[]`로 변경되었다.
- 대용량 힙을 지닌 애플리케션에서 콤팩트 스트링 하나로 상당한 성능 효과를 기대할 수 있다.

### 15.1.3 새로운 스트링 연결

- 문자열을 이어붙일 때 자바 5 이래로 `StringBuilder`를 많이 사용해왔다.
- 자바 9부터 `invokedynamic`을 활용하여 생성되는 바이트코드를 줄일 수 있게 되었다.
- `java -verbose` 명령으로 살펴보면 상수 풀에 bootstrap 메서드가 보인다.
    - `StringConcatFactory.makeConcatWithConstants()`
    - 이 팩토리 메서드로 스트링 연결 레시피를 제공
- 위 기법을 응용하여 새로운 커스텀 메서드용 바이트코드 작성 등 다양한 전략을 구사할 수 있다.

### 15.1.4 C2 컴파일러 개선

- C2 컴파일러는 많이 성숙했기에 눈에 띄는 개선을 없을 것이다.
- 하지만 현대 CPU에 선보인 [SIMD(single instruction multiple data)](https://ko.wikipedia.org/wiki/SIMD) 확장 기능을 응용하면 성능 개선을 기대할 수 있다.
- 자바/JVM 플랫폼은 SIMD를 효과적으로 활용하기 좋다.
    - 바이트코드는 플랫폼과 무관
    - JVM은 시동 시 CPU를 탐색하므로 현재 하드웨어를 런타임에 파악 가능
    - JIT 컴파일은 코드를 동적 생성하기에 사용 가능한 모든 명령을 호스트에서 사용할 수 있다.
- 이러한 개선은 VM 인트린직으로 구현할 수 있다.
    - 인트린직 - JVM이 이미 알고 있는 고도로 튜닝된 네이티브 메서드 구현체
    - JVM은 런타임에 자신을 실행한 하드웨어 따라 사용 가능한 기능을 목록화 가능
    - 인트린직은 가볍고 강력하고 유연하다.
- 핫스팟은 이미 다음과 같은 x86 SIMD 명령어를 지원
    - 자바 코드의 자동 백터화
    - 순차 코드에서 SIMD 코드를 얻기 위해 C2에서 슈퍼워드 최적화
    - 배열 복사/적재/비교 등의 JVM SIMD 인트린직
- 자바 9에선 SIMD의 장점과 연관된 프로세서 특징을 잘 활용하고자 기존 인트린직을 개선하거나 새로운 인트린직을 탑재했다.
    - 마스킹된 백터 포스트 루프
    - 슈퍼워드 루프 펼치기 분석
    - 멀티비저닝으로 범위 체크 제거
    - 배정도 제곱근 백터화 지원
    - 병렬 스트림의 백터화 개선
    - 슈퍼워드를 개선하여 인텔 AVX CPU상에서 백터 조건부 이동 지원
- 일반적으로 인트린직은 범용 기술이 아닌 특정 해결책이라 봐야 한다.
    - 여러 아키텍처를 고루 지원해야 하므로 개발/유지보수 비용이 크다.

### 15.1.5 G1 새 버전

- 자바 9부터 G1이 디폴트 가비지 수집기가 되었다.
    - G1은 중단 시간을 쉽게 튜닝하고 더 효과적으로 제어하는 특성을 지님

## 15.2 자바 10과 그 이후 버전

### 15.2.1 새로운 릴리즈 절차

- 자바 10 이전에는 특성 위주로 새 버전이 나왔다.
    - 특정 릴리즈를 목표로 주요 변경 사항 구현
    - 새로운 특성이 준비될 때까지 릴리즈를 미루기도 함
    - 때문에 자바 9 릴리즈도 상당이 지연되었다.
    - 릴리즈 개발 후 풀 테스트까지 오래 거릴는 탓에 소소한 특성이 주요 특성에 가려지는 경우도 많았다.
    - 릴리즈가 미뤄지며 소스 코드 저장소는 방치되기 일쑤
- 자바 10부터는 정확한 시기에 릴리즈되는 모델로 개편되었다.
    - 앞으로 새 버전이 6개월마다 릴리즈
    - 이른바 특성 릴리즈(feature release)
- 오라클은 일부 특성 릴리즈에 대해 장기지원(LTS, long-term support)를 제공한다.

### 15.2.2 자바 10

- JVM 특성 및 개선 사항은 [자바 개선 프로세스](https://openjdk.org/jeps/1)를 통해 관리
- 자바 10 주요 특성의 일부
    - 286: 지역 변수 타입 추론
        - `var`
    - 296: JDK 포레스트를 단일 리파지터리로 통합
    - 304: 가비지 수집기 인터페이스
    - 307: G1에서 풀 병렬 GC 구현
        - 풀 GC 발생시 성능 병목 문제 해결
        - 자바 9에선 싱글 스레드인 마크-스위프-컴팩트 알고리즘 사용
        - JEP 307에선 이 알고리즘을 병렬화
    - 310: 애플리케이션 클래스 데이터 공유
        - 자바 5의 클래스 데이터 공유 특성 확장
        - JVM이 일습의 클래스를 기록해 공유 아카이브 파일 하나로 처리하여 메모리에 매핑
        - 다음에 실행할 때 시간 절약 가능
        - 여러 JVM이 같은 호스트에서 실행할 때 전체 메모리 사용량 감소
    - 312: 스레드 로컬 핸드쉐이크
        - 애플리케이션 스레드에 콜백을 실행하여 전역 VM 세이브포인트를 수행하지 않게 하여 VM 성능 개선
        - 스레드 전체가 아닌 개별 스레드 단위로 멈추게 하자
        - 샘플링 편향을 줄일 수 있다.
        - 바이어스 취소 시 바이어스 락킹 작업이 향상됨
        - JVM에서 일부 메모리 베리어를 제거 가능
